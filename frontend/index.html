<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A fair, private way to close salary negotiations. Double-blind mechanism that splits the difference when ranges overlap.">
    <meta name="theme-color" content="#0F0518">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    
    <title>The Closing Table</title>
    
    <!-- Resource Hints for Performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://grainy-gradients.vercel.app">
    
    <!-- Optimized Font Loading -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700;900&family=JetBrains+Mono:wght@400;500;600&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700;900&family=JetBrains+Mono:wght@400;500;600&display=swap"></noscript>
    
    <!-- Core React Imports - Production Builds for Better Performance -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    <style>
        body {
            background: radial-gradient(circle at center, #2e1846 0%, #1e102c 100%);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #2e1846 0%, #1e102c 100%);
            pointer-events: none;
            z-index: 0;
        }


        @keyframes floatUp {
            0% { transform: translateY(0) translateX(0); opacity: .05; }
            50% { opacity: .12; }
            100% { transform: translateY(-120vh) translateX(10vw); opacity: 0; }
        }

        .floating-symbol {
            position: fixed;
            font-size: 12px;
            color: #F5C04A;
            opacity: .08;
            pointer-events: none;
            z-index: 1;
            animation: floatUp linear infinite;
        }

        @keyframes goldPulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 192, 74, 0.4); }
            100% { box-shadow: 0 0 30px 20px rgba(245, 192, 74, 0); }
        }

        .gold-pulse {
            animation: goldPulse 1.6s ease-out infinite;
        }

        @keyframes sliderGlow {
            0% { filter: drop-shadow(0 0 4px rgba(245,192,74,0.4)); }
            50% { filter: drop-shadow(0 0 10px rgba(245,192,74,0.8)); }
            100% { filter: drop-shadow(0 0 4px rgba(245,192,74,0.4)); }
        }

        .slider-glow {
            animation: sliderGlow 2.5s ease-in-out infinite;
        }

        @keyframes illuminate {
            0% { opacity: .4; transform: scale(.95); }
            100% { opacity: .8; transform: scale(1.05); }
        }

        .oracle-glow {
            animation: illuminate 1.8s ease-in-out infinite alternate;
        }

        .glass-panel {
            background: rgba(30, 10, 60, 0.55);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(245, 192, 74, 0.25);
            box-shadow: 
                0 32px 80px rgba(0, 0, 0, 0.45),
                0 16px 40px rgba(0, 0, 0, 0.35),
                0 8px 20px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(245, 192, 74, 0.15);
            border-radius: 1rem;
            position: relative;
            padding: 2rem;
        }

        .glass-panel::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(100, 100, 100, 0.05) 0%, transparent 50%);
            opacity: 0.3;
            pointer-events: none;
            border-radius: inherit;
        }

        .lime-text-gradient {
            background: linear-gradient(to right, #A7EF00, #C8FF4D);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-enter {
            animation: fade-in-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* --- APP SHELL & BACKGROUND GLOW --- */
        .app-shell {
            position: relative;
            overflow: hidden;
        }

        .app-shell::before {
            content: "";
            position: fixed;
            inset: -35%;
            background:
                radial-gradient(circle at 0% 0%, rgba(167, 239, 0, 0.15), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(45, 20, 85, 0.12), transparent 55%);
            filter: blur(40px);
            opacity: 0.6;
            animation: float-bg 26s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes float-bg {
            from {
                transform: translate3d(-24px, 14px, 0) scale(1);
            }
            to {
                transform: translate3d(28px, -20px, 0) scale(1.04);
            }
        }

        /* --- TYPOGRAPHY POLISH --- */
        .hero-heading {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.8rem, 4vw, 3.8rem);
            letter-spacing: -0.04em;
            line-height: 1.03;
            font-weight: 700;
            background: linear-gradient(90deg, #FCD34D 0%, #F59E0B 25%, #FCD34D 50%, #F59E0B 75%, #FCD34D 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: title-light-sweep 10s linear infinite;
        }

        @keyframes title-light-sweep {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        .financial-number {
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .hero-subtitle {
            font-size: clamp(1.05rem, 1.4vw, 1.3rem);
            color: #CBD5E1;
            max-width: 36rem;
            margin-inline: auto;
        }

        .section-label {
            font-size: 0.7rem;
            letter-spacing: 0.22em;
            text-transform: uppercase;
        }

        /* --- INPUT MATERIALITY (Frosted Glass) --- */
        .frosted-input {
            background: rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* --- BUTTON MICRO-ANIMATION --- */
        .btn {
            position: relative;
            overflow: hidden;
            background-size: 200% 100%;
        }

        .btn-lime-sweep {
            animation: gradient-shift 4s ease-in-out infinite;
        }

        @keyframes gradient-shift {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .btn::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(
                120deg,
                transparent 0%,
                rgba(255, 255, 255, 0.14) 30%,
                transparent 60%
            );
            transform: translate3d(-120%, 0, 0);
            opacity: 0;
            pointer-events: none;
        }

        .btn:hover::before {
            opacity: 1;
            transform: translate3d(120%, 0, 0);
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.3s ease-out;
        }

        /* --- LOCK ICON GLOW ON BUTTON HOVER --- */
        .btn:hover .lock-charge-up {
            filter: drop-shadow(0 0 8px #FCD34D) drop-shadow(0 0 12px rgba(252, 211, 77, 0.6)) drop-shadow(0 0 16px rgba(252, 211, 77, 0.3));
            transform: scale(1.1);
            transition: filter 0.3s ease-out, transform 0.3s ease-out;
        }

        /* --- CARD HOVER --- */
        .card-hover {
            transition:
                transform 0.35s cubic-bezier(0.16, 1, 0.3, 1),
                box-shadow 0.35s cubic-bezier(0.16, 1, 0.3, 1),
                border-color 0.35s ease-out,
                background-color 0.35s ease-out;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.75);
            border-color: rgba(148, 163, 184, 0.55);
            background-color: rgba(30, 10, 60, 0.78);
        }

        /* --- JACKPOT NUMBER ANIMATION & SCALING --- */
        .jackpot-number {
            display: inline-block;
            transform-origin: center;
            transition:
                transform 0.22s cubic-bezier(0.22, 1, 0.36, 1),
                filter 0.22s ease-out;
        }

        .jackpot-number.jackpot-active {
            animation: jackpot-rise 0.24s cubic-bezier(0.22, 1, 0.36, 1);
            filter: drop-shadow(0 0 18px rgba(250, 250, 210, 0.35));
        }

        @keyframes jackpot-rise {
            0% {
                transform: translateY(10px) scale(1.02);
                opacity: 0.45;
            }
            55% {
                transform: translateY(-4px) scale(1.12);
                opacity: 1;
            }
            100% {
                transform: translateY(0) scale(1.06);
                opacity: 1;
            }
        }

        /* --- HUSH FIELD FOCUS --- */
        .hush-hint {
            transition: opacity 0.15s ease-out;
        }

        .hush-hint.hidden {
            opacity: 0;
        }

        /* --- LOCK ICON CHARGE-UP --- */
        .lock-charge-up {
            transition: filter 0.3s ease-out, transform 0.3s ease-out;
        }

        .lock-charge-up:hover {
            filter: drop-shadow(0 0 8px #FCD34D) drop-shadow(0 0 12px rgba(252, 211, 77, 0.6));
            transform: scale(1.05);
        }

        .btn-lime-sweep::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(
                120deg,
                transparent 0%,
                rgba(167, 239, 0, 0.3) 30%,
                transparent 60%
            );
            transform: translate3d(-120%, 0, 0);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.3s ease-out;
        }

        .btn-lime-sweep:hover::before {
            opacity: 1;
            transform: translate3d(120%, 0, 0);
        }

        /* --- URL COPY CONFIRMATION --- */
        @keyframes url-flip {
            0% {
                transform: rotateY(0deg);
                background: rgba(0, 0, 0, 0.3);
            }
            50% {
                transform: rotateY(90deg);
                background: #A7EF00;
            }
            100% {
                transform: rotateY(0deg);
                background: rgba(0, 0, 0, 0.3);
            }
        }

        .url-flip-active {
            animation: url-flip 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .url-checkmark {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
        }

        .url-flip-active .url-checkmark {
            opacity: 1;
            animation: checkmark-fade 0.6s ease-out;
        }

        @keyframes checkmark-fade {
            0%, 100% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* --- CANDIDATE LIME FLASH (Personal Confirmation) --- */
        @keyframes candidate-lime-flash {
            0% {
                color: #F1F5F9;
                filter: drop-shadow(0 0 0px rgba(167, 239, 0, 0));
            }
            30% {
                color: #A7EF00;
                filter: drop-shadow(0 0 12px rgba(167, 239, 0, 0.6)) drop-shadow(0 0 24px rgba(167, 239, 0, 0.3));
            }
            70% {
                color: #A7EF00;
                filter: drop-shadow(0 0 8px rgba(167, 239, 0, 0.4)) drop-shadow(0 0 16px rgba(167, 239, 0, 0.2));
            }
            100% {
                color: #F1F5F9;
                filter: drop-shadow(0 0 0px rgba(167, 239, 0, 0));
            }
        }

        .candidate-confirm-flash {
            animation: candidate-lime-flash 0.8s cubic-bezier(0.22, 1, 0.36, 1);
        }


        @keyframes pulse-subtle {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 0.7;
            }
        }


        /* --- INTERACTIVE VIGNETTE --- */
        .vignette-active {
            animation: vignette-focus 0.4s ease-out forwards;
        }

        @keyframes vignette-focus {
            0% {
                background: radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.6) 70%);
            }
            100% {
                background: radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.4) 60%);
            }
        }

        /* --- LED FLICKER ANIMATION --- */
        @keyframes led-flicker {
            0%, 100% { opacity: 1; transform: scale(1); }
            10% { opacity: 0.3; transform: scale(0.98); }
            20% { opacity: 1; transform: scale(1.02); }
            30% { opacity: 0.5; transform: scale(0.99); }
            40% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.01); }
            60% { opacity: 1; transform: scale(1); }
        }

        .led-flicker {
            animation: led-flicker 0.15s ease-out;
        }

        /* --- SECURITY SEAL ANIMATION --- */
        @keyframes security-seal {
            0% { 
                background: linear-gradient(to right, #FCD34D, #F59E0B);
                border-color: transparent;
            }
            50% {
                background: linear-gradient(to right, #FCD34D, #F59E0B);
                border-color: transparent;
            }
            100% {
                background: linear-gradient(to right, #FCD34D, #F59E0B);
                border: 2px solid;
                border-image: linear-gradient(135deg, #FCD34D, #F59E0B, #D97706) 1;
            }
        }

        .security-seal-active {
            animation: security-seal 2s ease-out forwards;
        }

        /* --- CARD SINK EFFECT --- */
        @keyframes card-sink {
            0% { transform: translateY(0); }
            50% { transform: translateY(2px); }
            100% { transform: translateY(0); }
        }

        .card-sink {
            animation: card-sink 0.2s ease-out;
        }

        /* --- VISUAL METAPHOR BAR (Hero Animation) --- */
        @keyframes marker-slide-left {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(15px); }
        }

        @keyframes marker-slide-right {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-15px); }
        }

        @keyframes overlap-highlight {
            0%, 100% { opacity: 0.3; }
            25%, 75% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .visual-metaphor-bar {
            height: 8px;
            background: linear-gradient(to right, #A7EF00 50%, #FCD34D 50%);
            border-radius: 9999px;
            position: relative;
            overflow: visible;
        }

        .visual-metaphor-marker {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid;
        }

        .visual-metaphor-marker.left {
            left: 20%;
            background: #A7EF00;
            border-color: #A7EF00;
            box-shadow: 0 0 8px rgba(167, 239, 0, 0.5);
            animation: marker-slide-left 4s ease-in-out infinite;
        }

        .visual-metaphor-marker.right {
            right: 20%;
            background: #FCD34D;
            border-color: #FCD34D;
            box-shadow: 0 0 8px rgba(252, 211, 77, 0.5);
            animation: marker-slide-right 4s ease-in-out infinite;
        }

        .visual-metaphor-overlap {
            position: absolute;
            left: 45%;
            width: 10%;
            height: 100%;
            background: linear-gradient(to right, #A7EF00, #FCD34D);
            border-radius: 9999px;
            opacity: 0.3;
            animation: overlap-highlight 4s ease-in-out infinite;
        }

        /* --- MECHANISM CALCULATION BAR --- */
        .calculation-bar-container {
            position: relative;
            width: 100%;
            height: 12px;
            background: #1D0D32;
            border-radius: 6px;
            overflow: visible;
        }

        .calculation-bar-range {
            position: absolute;
            height: 100%;
            background: linear-gradient(to right, #A7EF00 0%, #A7EF00 50%, #FCD34D 50%, #FCD34D 100%);
            border-radius: 6px;
        }

        .calculation-bar-split-point {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 20px;
            background: #F1F5F9;
            box-shadow: 0 0 8px rgba(241, 245, 249, 0.6);
            z-index: 2;
        }

        .calculation-bar-label {
            position: absolute;
            top: -24px;
            font-size: 11px;
            font-weight: 600;
            color: #CBD5E1;
            white-space: nowrap;
        }

        .calculation-bar-label.left {
            left: 0;
            color: #A7EF00;
        }

        .calculation-bar-label.right {
            right: 0;
            color: #FCD34D;
        }

        .calculation-bar-label.center {
            left: 50%;
            transform: translateX(-50%);
            color: #F1F5F9;
        }

        /* --- COMMITMENT CONFIRMATION ANIMATION --- */
        @keyframes vault-lock {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(5deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }

        @keyframes scale-balance {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-10px) rotate(-2deg); }
            75% { transform: translateX(10px) rotate(2deg); }
        }

        @keyframes text-flash {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .vault-icon {
            animation: vault-lock 1s ease-in-out;
        }

        .scale-icon {
            animation: scale-balance 2s ease-in-out infinite;
        }

        .commitment-text {
            animation: text-flash 1.5s ease-in-out;
        }

        /* --- SURPLUS GAINED COUNTER --- */
        @keyframes counter-pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .surplus-counter {
            animation: counter-pop 0.6s ease-out;
        }

        /* --- OUTCOME BAR VISUALIZATION --- */
        .outcome-bar-container {
            position: relative;
            width: 100%;
            height: 16px;
            background: #1D0D32;
            border-radius: 8px;
            overflow: visible;
            margin: 24px 0;
        }

        .outcome-bar-fair-split {
            background: linear-gradient(to right, #A7EF00 0%, #A7EF00 50%, #FCD34D 50%, #FCD34D 100%);
            height: 100%;
            border-radius: 8px;
            position: relative;
        }

        .outcome-bar-bridge {
            background: linear-gradient(to right, #A7EF00 0%, #A7EF00 45%, #FACC15 45%, #FACC15 55%, #FCD34D 55%, #FCD34D 100%);
            height: 100%;
            border-radius: 8px;
            position: relative;
        }

        .outcome-bar-no-deal {
            background: linear-gradient(to right, #A7EF00 0%, #A7EF00 40%, #EF4444 40%, #EF4444 100%);
            height: 100%;
            border-radius: 8px;
            position: relative;
        }

        .outcome-bar-label {
            position: absolute;
            top: -20px;
            font-size: 10px;
            font-weight: 600;
            color: #CBD5E1;
            white-space: nowrap;
        }

        .outcome-bar-split-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 5, 24, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            color: #F1F5F9;
            white-space: nowrap;
        }

        /* --- TOOLTIP STYLES (Pristine Theme) --- */
        .whisper-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(15, 5, 24, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(203, 213, 225, 0.3);
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #CBD5E1;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            z-index: 1000;
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(45, 20, 85, 0.5) inset;
            clip-path: polygon(0% 0%, 100% 0%, 100% calc(100% - 8px), calc(50% + 6px) calc(100% - 8px), 50% 100%, calc(50% - 6px) calc(100% - 8px), 0% calc(100% - 8px));
        }

        .whisper-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(15, 5, 24, 0.95);
        }

        .tooltip-trigger:hover .whisper-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }

        /* --- SAFE DIAL KNOB (Metallic Gold) --- */
        .safe-knob {
            position: relative;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #F5C04A 0%, #E6AC2E 30%, #F5C04A 60%, #D97706 100%);
            border: 2px solid rgba(245, 192, 74, 0.4);
            border-radius: 50%;
            box-shadow: 
                0 0 16px rgba(245, 192, 74, 0.6),
                0 0 8px rgba(245, 192, 74, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.5),
                inset 0 2px 4px rgba(255, 255, 255, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.4);
            transition: transform 0.1s linear;
        }

        .safe-knob.slider-glow {
            animation: sliderGlow 2.5s ease-in-out infinite;
        }

        .safe-knob::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background: rgba(252, 211, 77, 0.9);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(252, 211, 77, 0.9);
        }

        .safe-knob::after {
            content: "";
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 6px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 1px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- API CONFIGURATION ---
        const API_BASE = 'https://closing-table-backend.onrender.com';

        // --- MECHANISM CONSTANTS ---
        const BRIDGE_ZONE_PCT = 0.10;       // 10% gap treated as "close, talk"
        const ROUNDING_GRANULARITY = 1000;  // $1,000 rounding

        // --- SIMPLE EVENT LOGGER ---
        function logEvent(type, payload = {}) {
            const event = {
                type,
                ts: new Date().toISOString(),
                ...payload,
            };
            console.log('[closing-table-event]', event);
        }

        // --- AUDIO CONTEXT FOR SOUND EFFECTS ---
        let audioContext = null;
        let tensionOscillator = null;

        function initAudio() {
            if (!audioContext && typeof AudioContext !== 'undefined') {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playTensionSound(progress) {
            initAudio();
            if (!audioContext) return;

            if (tensionOscillator) {
                tensionOscillator.stop();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 80 + (progress * 40);
            oscillator.type = 'sine';
            gainNode.gain.value = 0.05 * (0.3 + progress * 0.7);

            oscillator.start();
            tensionOscillator = oscillator;
        }

        function stopTensionSound() {
            if (tensionOscillator) {
                tensionOscillator.stop();
                tensionOscillator = null;
            }
        }

        function playThunkSound() {
            initAudio();
            if (!audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(60, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(30, audioContext.currentTime + 0.1);
            oscillator.type = 'sawtooth';
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function playMagneticLatchSound() {
            initAudio();
            if (!audioContext) return;

            // Heavier, deeper sound for candidate's "Lock In" action
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(45, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(25, audioContext.currentTime + 0.15);
            oscillator.type = 'sawtooth';
            gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.005, audioContext.currentTime + 0.2);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.2);

            // Haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate([50, 30, 50]);
            }
        }

        // --- HAPTIC FEEDBACK ---
        function triggerHaptic() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // --- CONFIGURATION (visual only) ---
        const COLORS = {
            BG: '#0F0518',
            CARD: '#2D1455',
            ACCENT: '#A7EF00',
            ACCENT_SEC: '#A7EF00',
            GOLD: '#FCD34D',
            TEXT_MAIN: '#F1F5F9',
            TEXT_MUTED: '#CBD5E1',
        };

        // --- ICONS ---
        const Icons = {
            Lock: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                    <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                </svg>
            ),
            Unlock: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                    <path d="M7 11V7a5 5 0 0 1 9.9-1" />
                </svg>
            ),
            Mail: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                    <polyline points="22,6 12,13 2,6" />
                </svg>
            ),
            Check: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <polyline points="20 6 9 17 4 12" />
                </svg>
            ),
            Copy: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                </svg>
            ),
            ArrowRight: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <line x1="5" y1="12" x2="19" y2="12" />
                    <polyline points="12 5 19 12 12 19" />
                </svg>
            ),
            Handshake: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <path d="m11 17 2 2a2 2 0 1 0 2.8-2.8l-6-6-2 2 2 2 2 2a2 2 0 1 1-2.8 2.8L11 17Z" />
                    <path d="m22 11-2-2-6 6-2-2-6 6-2-2a2 2 0 0 1 2.8-2.8l6 6 2-2 6-6 2 2 2 2a2 2 0 0 1 2.8 2.8l-2 2Z" />
                </svg>
            ),
            Phone: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
                </svg>
            ),
            Shield: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
            ),
            TrendingUp: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
                    <polyline points="18 7 22 7 22 11" />
                </svg>
            ),
            Terminal: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <polyline points="4 17 10 11 4 5" />
                    <line x1="12" y1="19" x2="20" y2="19" />
                </svg>
            ),
            Info: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
            ),
        };

        // --- COMPONENTS ---

        const WhisperTooltip = ({ text, children }) => {
            return (
                <div className="tooltip-trigger relative inline-block">
                    {children}
                    <div className="whisper-tooltip">
                        {text}
                    </div>
                </div>
            );
        };

        const Slider = ({ value, onChange, min, max, step, onDragStart, onDragEnd }) => {
            const [isDragging, setIsDragging] = useState(false);
            const [rotation, setRotation] = useState(0);
            const percent = ((value - min) / (max - min)) * 100;
            const prevValueRef = useRef(value);

            const handleChange = (e) => {
                const newValue = parseInt(e.target.value, 10);
                const progress = (newValue - min) / (max - min);
                
                if (!isDragging) {
                    setIsDragging(true);
                    if (onDragStart) onDragStart();
                }

                setRotation(prev => prev + (newValue - prevValueRef.current) * 2);
                prevValueRef.current = newValue;
                playTensionSound(progress);
                onChange(e);
            };

            const handleMouseUp = () => {
                if (isDragging) {
                    setIsDragging(false);
                    stopTensionSound();
                    playThunkSound();
                    if (onDragEnd) onDragEnd();
                }
            };

            useEffect(() => {
                if (!isDragging) {
                    setRotation(0);
                }
            }, [isDragging]);

            return (
                <div className="relative w-full h-12 flex items-center group" onMouseUp={handleMouseUp} onTouchEnd={handleMouseUp}>
                    <div className="absolute w-full h-3 bg-gradient-to-r from-[#1D0D32] via-[#2D1455] to-[#3D1C65] rounded-full overflow-hidden" style={{ boxShadow: 'inset 0 2px 4px rgba(0, 0, 0, 0.4)' }}>
                        <div
                            className="h-full bg-[#A7EF00]"
                            style={{ width: `${percent}%` }}
                        />
                    </div>
                    <input
                        type="range"
                        min={min}
                        max={max}
                        step={step}
                        value={value}
                        onChange={handleChange}
                        onMouseDown={() => setIsDragging(true)}
                        onTouchStart={() => setIsDragging(true)}
                        aria-label={`Slider value: ${value}`}
                        className="absolute w-full h-full opacity-0 cursor-pointer z-20"
                    />
                    <div
                        className="w-6 h-6 bg-yellow-400 rounded-full shadow-[0_0_10px_rgba(245,192,74,0.8)] border border-yellow-300 slider-glow absolute z-10 pointer-events-none"
                        style={{ 
                            left: `calc(${percent}% - 12px)`,
                            transform: `rotate(${rotation}deg)`
                        }}
                    />
                </div>
            );
        };

        const Button = ({ children, onClick, disabled, variant = 'primary', className = '' }) => {
            const baseStyle =
                "btn relative transform transition-all duration-200 " +
                "flex items-center justify-center gap-3 " +
                "hover:-translate-y-0.5 active:translate-y-0 active:scale-95 " +
                "disabled:opacity-50 disabled:cursor-not-allowed " +
                "focus:outline-none focus-visible:ring-2 focus-visible:ring-[#F5C04A]/80 " +
                "focus-visible:ring-offset-2 focus-visible:ring-offset-[#0F0518]";

            const variants = {
                primary: "bg-yellow-400 text-black font-semibold py-4 px-6 rounded-xl shadow-[0_0_20px_rgba(245,192,74,0.4)] hover:shadow-[0_0_30px_rgba(245,192,74,0.6)] transition-all",
                secondary: "bg-white/10 text-[#F1F5F9] border border-white/10 hover:bg-white/20 backdrop-blur-md",
                outline: "border-2 border-[#CBD5E1] text-[#CBD5E1] hover:border-[#F5C04A] hover:text-[#F5C04A]",
                gold: "bg-yellow-400 text-black font-semibold py-4 px-6 rounded-xl shadow-[0_0_20px_rgba(245,192,74,0.4)] hover:shadow-[0_0_30px_rgba(245,192,74,0.6)] transition-all",
                danger: "bg-[#EF4444] text-[#F1F5F9] shadow-lg shadow-[#EF4444]/20 hover:bg-[#DC2626]",
                ai: "bg-lime-900/40 text-lime-400 border border-lime-700 hover:bg-lime-900/60 shadow-md shadow-lime-900/50",
            };

            return (
                <button
                    onClick={onClick}
                    disabled={disabled}
                    aria-disabled={disabled}
                    className={`${baseStyle} ${variants[variant]} ${className}`}
                >
                    {children}
                </button>
            );
        };

        const GlassCard = ({ children, className = '', onInteraction }) => {
            const cardRef = useRef(null);

            useEffect(() => {
                if (!cardRef.current || !onInteraction) return;

                const card = cardRef.current;
                const handleFocus = () => {
                    if (onInteraction) onInteraction(true);
                };
                const handleBlur = () => {
                    if (onInteraction) onInteraction(false);
                };

                const inputs = card.querySelectorAll('input, button, [role="slider"]');
                inputs.forEach(input => {
                    input.addEventListener('focus', handleFocus);
                    input.addEventListener('blur', handleBlur);
                });

                return () => {
                    inputs.forEach(input => {
                        input.removeEventListener('focus', handleFocus);
                        input.removeEventListener('blur', handleBlur);
                    });
                };
            }, [onInteraction]);

            return (
                <div ref={cardRef} className={`backdrop-blur-xl bg-[rgba(30,10,60,0.55)] border border-[rgba(245,192,74,0.25)] shadow-[0_0_20px_rgba(245,192,74,0.15)] rounded-2xl p-8 card-hover ${className}`}>
                    {children}
                </div>
            );
        };


        const FloatingSymbols = () => {
            const symbols = ["ðŸ”‘", "âœ¨", "ðŸ’°", "ðŸ”’", "ðŸ‘‘"];
            const items = Array.from({ length: 18 });

            return (
                <div>
                    {items.map((_, i) => {
                        const sym = symbols[Math.floor(Math.random() * symbols.length)];
                        const left = Math.random() * 100;
                        const delay = Math.random() * 20;
                        const dur = 20 + Math.random() * 30;

                        return (
                            <div
                                key={i}
                                className="floating-symbol"
                                style={{
                                    left: `${left}vw`,
                                    bottom: `-10vh`,
                                    animationDuration: `${dur}s`,
                                    animationDelay: `${delay}s`,
                                }}
                            >
                                {sym}
                            </div>
                        );
                    })}
                </div>
            );
        };

        const SplitDiagram = () => (
            <div className="my-8 p-6 bg-[#2e1846]/50 rounded-2xl border border-[#F5C04A]/20">
                <div className="relative h-16 w-full flex items-center">
                    <div className="absolute w-full h-2 bg-[#2e1846] rounded-full"></div>
                    <div className="absolute inset-0 rounded-full bg-yellow-400/40 oracle-glow"></div>
                    <div className="absolute left-1/4 right-1/4 h-2 bg-[#F5C04A] rounded-full opacity-80"></div>
                    <div className="absolute left-1/4 top-[-16px] flex flex-col items-center">
                        <span className="text-xs font-bold text-[#F1F5F9] mb-1">You</span>
                        <div className="w-4 h-4 bg-[#F5C04A] rounded-full border-2 border-[#F5C04A] shadow-[0_0_8px_rgba(245,192,74,0.6)]"></div>
                    </div>
                    <div className="absolute left-1/2 top-4 flex flex-col items-center">
                        <div className="h-6 w-px bg-[#F5C04A] mb-1" style={{ boxShadow: '0 0 4px rgba(245, 192, 74, 0.8)' }}></div>
                        <span className="text-xs font-bold text-yellow-400">Split Surplus</span>
                    </div>
                    <div className="absolute right-1/4 top-[-16px] flex flex-col items-center">
                        <span className="text-xs font-bold text-[#CBD5E1] mb-1">Company</span>
                        <div className="w-4 h-4 bg-[#CBD5E1] rounded-full border-2 border-[#F5C04A] shadow-[0_0_8px_rgba(245,192,74,0.4)]"></div>
                    </div>
                </div>
            </div>
        );

        // --- COMPANY VIEW ---

        const CompanyView = () => {
            const [budget, setBudget] = useState(140000);
            const [email, setEmail] = useState('');
            const [link, setLink] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [budgetAnimating, setBudgetAnimating] = useState(false);
            const [ledFlicker, setLedFlicker] = useState(false);
            const [cardSink, setCardSink] = useState(false);
            const [securitySeal, setSecuritySeal] = useState(false);
            const cardRef = useRef(null);

            const COMPANY_MIN = 50000;
            const COMPANY_MAX = 300000;

            const budgetScale = (() => {
                const norm = Math.min(
                    1,
                    Math.max(0, (budget - COMPANY_MIN) / (COMPANY_MAX - COMPANY_MIN))
                );
                return 0.98 + norm * 0.18; // grows up to ~1.16 near the top
            })();

            const generateLink = async () => {
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(`${API_BASE}/api/offers`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ max: budget, email }),
                    });

                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (jsonErr) {
                            throw new Error(`HTTP ${response.status}: Failed to create offer`);
                        }
                        throw new Error(errorData.error || 'Failed to create offer');
                    }

                    let responseData;
                    try {
                        responseData = await response.json();
                    } catch (jsonErr) {
                        throw new Error('Invalid response from server');
                    }
                    const { offerId } = responseData;
                    const newLink = `${window.location.origin}${window.location.pathname}#offer=${offerId}`;
                    setLink(newLink);

                    logEvent('offer_created', {
                        max: budget,
                        email,
                        offerId,
                    });
                } catch (err) {
                    setError(err.message);
                    logEvent('offer_create_error', { error: err.message });
                } finally {
                    setLoading(false);
                }
            };

            const copyLink = async () => {
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(link);
                        alert("Link copied to clipboard");
                        logEvent('offer_link_copied', { linkLength: link.length });
                        return;
                    }
                } catch (err) {
                    console.warn('Clipboard API failed, trying fallback:', err);
                }
                
                const textarea = document.createElement('textarea');
                textarea.value = link;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                textarea.setAttribute('aria-hidden', 'true');
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert("Link copied to clipboard");
                    logEvent('offer_link_copied', { linkLength: link.length });
                } catch (err) {
                    console.error('Could not copy text: ', err);
                }
                document.body.removeChild(textarea);
            };

            const handleBudgetChange = (e) => {
                const value = parseInt(e.target.value, 10);
                if (isNaN(value)) return;

                setBudget(prev => {
                    if (value !== prev) {
                        setBudgetAnimating(true);
                        setLedFlicker(true);
                        setTimeout(() => {
                            setBudgetAnimating(false);
                            setLedFlicker(false);
                        }, 200);
                    }
                    return value;
                });
            };

            const handleGenerateLink = async () => {
                triggerHaptic();
                setCardSink(true);
                setTimeout(() => setCardSink(false), 200);
                
                await generateLink();
                
                // Check if link was successfully created
                setTimeout(() => {
                    if (link) {
                        setSecuritySeal(true);
                        setTimeout(() => setSecuritySeal(false), 2000);
                    }
                }, 100);
            };

            if (link) {
                return (
                    <div className="max-w-2xl mx-auto animate-enter text-center">
                        <div className="mb-8 inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-[#FCD34D] to-[#F59E0B] shadow-2xl shadow-[#FCD34D]/30 mx-auto">
                            <Icons.Lock className="w-10 h-10 text-black" />
                        </div>
                        <h1 className="text-4xl md:text-6xl font-bold mb-6 text-[#F1F5F9]">
                            Terms Locked.
                        </h1>
                        <p className="text-xl text-[#CBD5E1] mb-10 leading-relaxed">
                            Your maximum terms are now fixed and prepared for the candidate.
                        </p>

                        <GlassCard className="mb-8">
                            <div className="bg-black/30 p-4 rounded-xl border border-white/10 flex items-center justify-between gap-4 mb-6 relative" id="url-container">
                                <code className="text-[#A7EF00] truncate flex-1 text-left font-mono text-sm">
                                    {link}
                                </code>
                                <div className="url-checkmark">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#0F0518" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </div>
                                <button
                                    onClick={copyLink}
                                    aria-label="Copy link to clipboard"
                                    className="p-2 hover:bg-white/10 rounded-lg transition"
                                >
                                    <Icons.Copy className="w-5 h-5 text-[#CBD5E1]" />
                                </button>
                            </div>
                            <div className="grid gap-4">
                                <Button onClick={() => {
                                    copyLink();
                                    const container = document.getElementById('url-container');
                                    if (container) {
                                        container.classList.add('url-flip-active');
                                        setTimeout(() => container.classList.remove('url-flip-active'), 600);
                                    }
                                }} variant="gold">
                                    Copy Link & Close
                                </Button>
                                <Button
                                    variant="secondary"
                                    onClick={() => {
                                        window.location.hash = `#offer=${link.split('offer=')[1]}`;
                                        window.location.reload();
                                    }}
                                >
                                    <Icons.ArrowRight className="w-5 h-5" />
                                    Preview Candidate View
                                </Button>
                            </div>
                        </GlassCard>
                    </div>
                );
            }

            return (
                <div className="max-w-2xl mx-auto animate-enter">
                    {/* Hero Section */}
                    <div className="text-left mb-10">
                        <h1 className="text-6xl font-extrabold text-yellow-400 tracking-tight mb-4">
                            The Closing Table
                        </h1>
                        <p className="text-xl text-gray-200/80 mt-4 leading-relaxed">
                            The single-shot mechanism for securing top talent. Set your CMax (True Maximum Budget). If the candidate's CMin fits, the surplus is split 50/50.
                        </p>
                    </div>

                    {/* Company Input Card - Main Feature */}
                    <GlassCard 
                        className={cardSink ? 'card-sink' : ''}
                        onInteraction={(active) => {
                            const body = document.body;
                            if (active) {
                                body.classList.add('vignette-active');
                            } else {
                                body.classList.remove('vignette-active');
                            }
                        }}
                    >
                        <p className="text-yellow-300 font-semibold uppercase text-sm tracking-wider mb-4">
                            TRUE MAXIMUM (CMax) â€” PRIVATE COMMITMENT
                        </p>
                        <p className="text-xs text-[#CBD5E1] mb-6 opacity-70">
                            This is your absolute ceiling. The candidate won't see this number until after they submit theirs.
                        </p>

                        <div className="flex items-baseline justify-start mb-4">
                            <span className="text-[#CBD5E1] text-4xl font-bold mr-2">$</span>
                            <span
                                className={
                                    "text-7xl font-bold text-[#F1F5F9] tracking-tighter jackpot-number financial-number " +
                                    (budgetAnimating ? "jackpot-active" : "") +
                                    (ledFlicker ? " led-flicker" : "")
                                }
                                style={{ transform: `scale(${budgetScale})` }}
                            >
                                {budget.toLocaleString()}
                            </span>
                        </div>

                        <div className="mb-10 px-4 mt-8">
                            <Slider
                                min={50000}
                                max={300000}
                                step={5000}
                                value={budget}
                                onChange={handleBudgetChange}
                                onDragStart={() => {}}
                                onDragEnd={() => {}}
                            />
                        </div>

                        <div className="space-y-8">
                            <div>
                                <label className="block text-xs font-bold text-[#CBD5E1] uppercase tracking-widest mb-4">
                                    Your Email
                                </label>
                                <div className="relative">
                                    <Icons.Mail className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[#CBD5E1]" />
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        onFocus={(e) => {
                                            const hint = e.target.nextElementSibling;
                                            if (hint) {
                                                hint.classList.add('hidden');
                                                setTimeout(() => hint.classList.remove('hidden'), 300);
                                            }
                                        }}
                                        placeholder="you@company.com"
                                        aria-label="Company email address"
                                        autoComplete="email"
                                        className="w-full frosted-input border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-[#F1F5F9] placeholder-[#CBD5E1] focus:outline-none focus:border-[#F5C04A] focus:ring-2 focus:ring-[#F5C04A]/30 hover:border-[#F5C04A]/50 transition-all duration-200"
                                    />
                                </div>
                                <p className="mt-3 text-xs text-[#CBD5E1] hush-hint">
                                    We'll send you the final result here. No spam, no storage beyond 7 days.
                                </p>
                            </div>

                            {error && (
                                <div className="bg-red-500/10 border border-red-500/30 p-4 rounded-xl">
                                    <p className="text-red-200 text-sm">{error}</p>
                                </div>
                            )}

                            <button 
                                onClick={handleGenerateLink} 
                                disabled={!email || loading}
                                className="w-full bg-yellow-400 hover:bg-amber-400 text-black font-semibold py-4 rounded-xl shadow-[0_0_20px_rgba(245,192,74,0.4)] transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <span className="text-xl">ðŸ”’</span>
                                {loading ? 'Creating Link...' : 'Commit Maximum & Generate Link'}
                            </button>

                            <p className="text-center text-xs text-gray-300 opacity-80">
                                The candidate will never see your CMax. This mechanism protects your budget from negotiation gamesmanship.
                            </p>
                        </div>
                    </GlassCard>

                </div>
            );
        };

        // --- CANDIDATE VIEW ---

        const CandidateView = ({ offerId }) => {
            const [ask, setAsk] = useState(120000);
            const [email, setEmail] = useState('');
            const [step, setStep] = useState('loading');
            const [result, setResult] = useState(null);
            const [marketData, setMarketData] = useState(null);
            const [loadingMarket, setLoadingMarket] = useState(false);
            const [offerStatus, setOfferStatus] = useState(null);
            const [error, setError] = useState(null);
            const marketDataTimeoutRef = useRef(null);
            const [askAnimating, setAskAnimating] = useState(false);
            const [ledFlicker, setLedFlicker] = useState(false);
            const [greenFlash, setGreenFlash] = useState(false);
            const [surplusCounter, setSurplusCounter] = useState(0);

            const ASK_MIN = 80000;
            const ASK_MAX = 250000;

            const askScale = (() => {
                const norm = Math.min(
                    1,
                    Math.max(0, (ask - ASK_MIN) / (ASK_MAX - ASK_MIN))
                );
                return 0.98 + norm * 0.18;
            })();

            // Check offer status on load
            useEffect(() => {
                // Validate offerId before making API call
                if (!offerId || typeof offerId !== 'string' || offerId.trim() === '') {
                    setError('Invalid offer link.');
                    setStep('error');
                    return;
                }

                const checkOffer = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/offers/${offerId}`);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        let data;
                        try {
                            data = await response.json();
                        } catch (jsonErr) {
                            throw new Error('Invalid response from server');
                        }
                        
                        if (data.status === 'invalid') {
                            setError('This offer link is not valid. It may have been typed incorrectly.');
                            setStep('error');
                            logEvent('offer_check_invalid', { offerId });
                        } else if (data.status === 'expired') {
                            setError('This offer has expired. Ask the company to generate a new link.');
                            setStep('error');
                            logEvent('offer_check_expired', { offerId });
                        } else if (data.status === 'used') {
                            setError('This link has already been used once. The mechanism only runs a single time per offer.');
                            setStep('error');
                            logEvent('offer_check_used', { offerId });
                        } else {
                            setOfferStatus('ok');
                            setStep('intro');
                            logEvent('offer_viewed', { offerId, status: 'ok' });
                        }
                    } catch (err) {
                        setError('Failed to load offer. Please check your connection.');
                        setStep('error');
                        logEvent('offer_check_error', { offerId, error: err.message });
                    }
                };

                if (offerId) {
                    checkOffer();
                }
            }, [offerId]);

            const handleAskChange = (e) => {
                const value = parseInt(e.target.value, 10);
                if (isNaN(value)) return;

                setAsk(prev => {
                    if (value !== prev) {
                        setAskAnimating(true);
                        setLedFlicker(true);
                        setTimeout(() => {
                            setAskAnimating(false);
                            setLedFlicker(false);
                        }, 200);
                    }
                    return value;
                });
            };

            const handleSliderRelease = () => {
                // Trigger green flash animation on slider release (personal confirmation)
                setGreenFlash(true);
                setTimeout(() => {
                    setGreenFlash(false);
                }, 800);
            };

            const fetchMarketData = () => {
                if (loadingMarket || marketData) return;
                setLoadingMarket(true);
                // Use a reasonable default for mock data (actual max not available from API)
                // In a real system, this would use the actual offer max from the API
                const defaultMax = 120000;
                // Clear any existing timeout
                if (marketDataTimeoutRef.current) {
                    clearTimeout(marketDataTimeoutRef.current);
                }
                marketDataTimeoutRef.current = setTimeout(() => {
                    // Mock market data - in real system this would come from API
                    const mockMarketValue =
                        Math.round((defaultMax * 0.95 + ROUNDING_GRANULARITY) / ROUNDING_GRANULARITY) *
                        ROUNDING_GRANULARITY;
                    setMarketData(mockMarketValue);
                    setLoadingMarket(false);
                    logEvent('market_data_shown', { suggested: mockMarketValue });
                    marketDataTimeoutRef.current = null;
                }, 1500);
            };

            // Cleanup timeout on unmount
            useEffect(() => {
                return () => {
                    if (marketDataTimeoutRef.current) {
                        clearTimeout(marketDataTimeoutRef.current);
                    }
                };
            }, []);

            const submit = async () => {
                // Validate offerId before submitting
                if (!offerId || typeof offerId !== 'string' || offerId.trim() === '') {
                    setError('Invalid offer link.');
                    setStep('error');
                    return;
                }

                setStep('submitting');
                try {
                    const response = await fetch(`${API_BASE}/api/offers/${offerId}/submit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ min: ask, email }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    let data;
                    try {
                        data = await response.json();
                    } catch (jsonErr) {
                        throw new Error('Invalid response from server');
                    }

                    if (data.status === 'invalid') {
                        setError('This offer link is not valid. It may have been typed incorrectly.');
                        setStep('error');
                        logEvent('submit_rejected', { offerId, status: data.status });
                        return;
                    } else if (data.status === 'expired') {
                        setError('This offer has expired. Ask the company to generate a new link.');
                        setStep('error');
                        logEvent('submit_rejected', { offerId, status: data.status });
                        return;
                    } else if (data.status === 'used') {
                        setError('This link has already been used once. The mechanism only runs a single time per offer.');
                        setStep('error');
                        logEvent('submit_rejected', { offerId, status: data.status });
                        return;
                    }

                    setResult(data);
                    setStep('result');

                    // Animate surplus counter if success
                    if (data.status === 'success') {
                        const benefit = data.final - ask;
                        const duration = 2000; // 2 seconds
                        const steps = 60;
                        const increment = benefit / steps;
                        const stepTime = duration / steps;
                        let current = 0;
                        const timer = setInterval(() => {
                            current += increment;
                            if (current >= benefit) {
                                setSurplusCounter(benefit);
                                clearInterval(timer);
                            } else {
                                setSurplusCounter(Math.floor(current));
                            }
                        }, stepTime);
                    }

                    logEvent('candidate_submitted', {
                        offerId,
                        min: ask,
                        status: data.status,
                        surplus: data.surplus,
                        gap: data.gap,
                        emailProvided: !!email,
                    });
                } catch (err) {
                    setError('Failed to submit. Please try again.');
                    setStep('error');
                    logEvent('submit_error', { offerId, error: err.message });
                }
            };

            if (step === 'loading') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <div className="text-[#CBD5E1]">Loading offer...</div>
                    </div>
                );
            }

            if (step === 'error') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <GlassCard className="border-red-500/30">
                            <div className="w-24 h-24 mx-auto rounded-full bg-red-500/20 flex items-center justify-center mb-8">
                                <Icons.Lock className="w-12 h-12 text-red-400" />
                            </div>
                            <h2 className="text-3xl font-bold text-[#F1F5F9] mb-4">Unable to Load Offer</h2>
                            <p className="text-[#CBD5E1] mb-6">{error}</p>
                            <Button variant="outline" onClick={() => {
                                window.location.hash = '';
                                window.location.reload();
                            }}>
                                Back to Start
                            </Button>
                        </GlassCard>
                    </div>
                );
            }

            if (step === 'submitting') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <div className="mb-8">
                            <div className="inline-flex items-center justify-center w-24 h-24 rounded-full bg-gradient-to-br from-[#A7EF00] to-[#C8FF4D] mb-6 vault-icon">
                                <Icons.Lock className="w-12 h-12 text-black" />
                            </div>
                            <div className="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-[#FCD34D] to-[#F59E0B] scale-icon">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <line x1="12" y1="2" x2="12" y2="22" />
                                    <line x1="2" y1="12" x2="22" y2="12" />
                                    <circle cx="8" cy="8" r="2" />
                                    <circle cx="16" cy="16" r="2" />
                                </svg>
                            </div>
                        </div>
                        <div className="space-y-3 text-lg text-[#CBD5E1]">
                            <p className="commitment-text font-bold text-yellow-400">Your number is locked.</p>
                            <p className="commitment-text">Calculating result...</p>
                            <p className="commitment-text font-bold text-[#FCD34D]">Almost there...</p>
                        </div>
                    </div>
                );
            }

            if (step === 'intro') {
                return (
                    <div className="max-w-6xl mx-auto animate-enter p-8">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
                            {/* Left Side */}
                            <div>
                                <h2 className="text-5xl font-extrabold text-yellow-400">Fair, Fast, Private Negotiation</h2>
                                <p className="text-gray-200/80 mt-4 text-lg leading-relaxed">
                                    Your true salary is secured here. Commit your minimum, and if it aligns with the company's maximum, the final, fairest offer is instantly secured. Zero Haggling. Zero Regrets.
                                </p>

                                <ul className="mt-10 space-y-6 text-gray-300">
                                    <li className="flex items-start gap-3">
                                        <span className="text-yellow-400 text-xl mt-1">1.</span>
                                        <span>The Company commits their <strong>CMax</strong> (Maximum Budget), sealed in the system.</span>
                                    </li>
                                    <li className="flex items-start gap-3">
                                        <span className="text-yellow-400 text-xl mt-1">2.</span>
                                        <span>You commit your <strong>CMin</strong> (Minimum Acceptable Salary), secured in the system.</span>
                                    </li>
                                    <li className="flex items-start gap-3">
                                        <span className="text-yellow-400 text-xl mt-1">3.</span>
                                        <span>If ranges overlap (<strong>CMin â‰¤ CMax</strong>), the Surplus is split 50/50 for a binding offer.</span>
                                    </li>
                                </ul>
                            </div>

                            {/* Right Side */}
                            <div>
                                <SplitDiagram />

                                <div className="mt-8 text-sm text-gray-300 bg-black/40 p-5 rounded-xl border border-white/10">
                                    <p className="font-semibold text-yellow-400 mb-2">The Algorithm for Fairness:</p>
                                    <p>If CMin â‰¤ CMax, then:</p>
                                    <p className="mt-1 text-yellow-300 font-medium">
                                        Final Offer = CMin + (CMax - CMin) / 2
                                    </p>
                                    <p className="mt-2 text-xs text-gray-500">
                                        *Rounded to the nearest $1,000 for privacy.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (step === 'input') {
                return (
                    <div className="max-w-xl mx-auto animate-enter">
                        <GlassCard>
                            {/* Check Market Data Button - Above Input */}
                            <div className="mb-6">
                                <Button
                                    variant="outline"
                                    onClick={fetchMarketData}
                                    disabled={loadingMarket || marketData}
                                    aria-label="Check market data for salary guidance"
                                    aria-busy={loadingMarket}
                                    className="w-full"
                                >
                                    {loadingMarket ? 'Loading...' : 'Get Market Guidance'}
                                </Button>
                                {marketData && (
                                    <div className="mt-3 p-4 bg-[#A7EF00]/10 border border-[#A7EF00]/30 rounded-xl text-left animate-enter">
                                        <p className="text-sm text-[#CBD5E1] mb-3">
                                            <strong className="text-[#A7EF00]">Suggested:</strong> ${marketData.toLocaleString()}
                                        </p>
                                        <button
                                            onClick={() => setAsk(marketData)}
                                            aria-label={`Set minimum salary to ${marketData.toLocaleString()}`}
                                            className="text-xs text-[#A7EF00] hover:text-[#A7EF00] underline transition-colors"
                                        >
                                            Use this amount
                                        </button>
                                    </div>
                                )}
                            </div>

                            <div className="text-left mb-8">
                                <label className="block text-sm font-extrabold text-yellow-400 uppercase tracking-widest mb-2">
                                    YOUR TRUE MINIMUM (CMin)
                                </label>
                                <p className="text-xs text-[#CBD5E1] mb-6 opacity-70">
                                    The lowest amount you'd accept. The company won't see this until after you submit.
                                </p>
                                <div className="flex items-baseline justify-start mb-6">
                                    <span className="text-[#CBD5E1] text-4xl font-bold mr-2">$</span>
                                    <span
                                        className={
                                            "text-7xl font-bold tracking-tighter jackpot-number financial-number " +
                                            (askAnimating ? "jackpot-active" : "") +
                                            (ledFlicker ? " led-flicker" : "") +
                                            (greenFlash ? " candidate-confirm-flash" : " text-[#F1F5F9]")
                                        }
                                        style={{ transform: `scale(${askScale})` }}
                                    >
                                        {ask.toLocaleString()}
                                    </span>
                                </div>
                            </div>

                            <div className="mb-10 mt-8">
                                <Slider
                                    min={80000}
                                    max={250000}
                                    step={1000}
                                    value={ask}
                                    onChange={handleAskChange}
                                    onDragStart={() => {}}
                                    onDragEnd={handleSliderRelease}
                                />
                            </div>

                            <div className="space-y-8">
                                <div className="text-left">
                                    <label className="block text-xs font-medium text-[#CBD5E1] mb-3">
                                        Your Email
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        onFocus={(e) => {
                                            const hint = e.target.nextElementSibling;
                                            if (hint) {
                                                hint.classList.add('hidden');
                                                setTimeout(() => hint.classList.remove('hidden'), 300);
                                            }
                                        }}
                                        placeholder="you@email.com"
                                        aria-label="Candidate email address"
                                        autoComplete="email"
                                        className="w-full frosted-input border border-white/10 rounded-2xl py-4 px-4 text-[#F1F5F9] focus:outline-none focus:border-[#F5C04A] focus:ring-2 focus:ring-[#F5C04A]/30 hover:border-[#F5C04A]/50 transition-all duration-200"
                                    />
                                    <p className="mt-3 text-xs text-[#CBD5E1] hush-hint">
                                        We'll send your result here. No spam, no long-term storage.
                                    </p>
                                </div>

                                <Button 
                                    onClick={() => {
                                        playMagneticLatchSound();
                                        submit();
                                    }} 
                                    disabled={!email} 
                                    className="w-full"
                                >
                                    ðŸ”’ Commit Min & Reveal Deal
                                </Button>
                            </div>
                        </GlassCard>
                    </div>
                );
            }

            if (step === 'result') {
                const isSuccess = result.status === 'success';
                const revealLink = result.resultId
                    ? `${window.location.origin}${window.location.pathname}#result=${encodeURIComponent(result.resultId)}`
                    : null;

                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <div
                            className={`w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-8 shadow-2xl ${
                                isSuccess
                                    ? 'bg-[#A7EF00] shadow-[#A7EF00]/50'
                                    : result.status === 'close'
                                    ? 'bg-[#FACC15] shadow-[#FACC15]/50'
                                    : 'bg-[#EF4444] shadow-[#EF4444]/50'
                            }`}
                            style={isSuccess ? { boxShadow: '0 0 40px rgba(167, 239, 0, 0.5), 0 0 80px rgba(167, 239, 0, 0.3)' } : {}}
                        >
                            {isSuccess ? (
                                <Icons.Handshake className="w-12 h-12 text-black" />
                            ) : result.status === 'close' ? (
                                <Icons.Phone className="w-12 h-12 text-black" />
                            ) : (
                                <Icons.Lock className="w-12 h-12 text-[#F1F5F9]" />
                            )}
                        </div>

                        <h2 className="text-5xl font-bold text-[#F1F5F9] mb-6">
                            {isSuccess
                                ? 'Deal Closed'
                                : result.status === 'close'
                                ? 'Close, But No Deal'
                                : 'No Deal'}
                        </h2>

                        {isSuccess ? (() => {
                            const cMin = ask;
                            const cMax = ask + result.surplus;
                            const benefitAboveMin = result.final - ask;
                            const splitAmount = result.surplus / 2;
                            
                            return (
                                <div className="space-y-8">
                                    {/* The Outcome Bar - FAIR SPLIT (Green) */}
                                    <GlassCard className="border-[#A7EF00]/30">
                                        <div className="mb-6">
                                            <div className="flex justify-between items-center mb-4">
                                                <div>
                                                    <p className="text-xs text-[#CBD5E1] mb-1">Your Minimum</p>
                                                    <p className="text-xl font-bold text-[#A7EF00]">${cMin.toLocaleString()}</p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-xs text-[#CBD5E1] mb-1">Company Maximum</p>
                                                    <p className="text-xl font-bold text-[#FCD34D]">${cMax.toLocaleString()}</p>
                                                </div>
                                            </div>
                                            
                                            <div className="outcome-bar-container">
                                                <div className="outcome-bar-fair-split">
                                                    <div className="outcome-bar-split-label">50/50 Split</div>
                                                </div>
                                                <div className="outcome-bar-label" style={{ left: '0%' }}>${cMin.toLocaleString()}</div>
                                                <div className="outcome-bar-label" style={{ left: '50%', transform: 'translateX(-50%)' }}>${result.final.toLocaleString()}</div>
                                                <div className="outcome-bar-label" style={{ right: '0%' }}>${cMax.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </GlassCard>

                                    {/* Final Offer with Surplus Counter */}
                                    <GlassCard className="border-[#F5C04A]/30">
                                        <p className="text-2xl font-extrabold text-yellow-400 mb-2">Final Salary</p>
                                        <p className="text-6xl font-bold text-white gold-pulse mb-6 tracking-tighter">
                                            ${result.final.toLocaleString()}
                                        </p>
                                        
                                        <div className="bg-[#A7EF00]/10 rounded-lg p-6 text-left">
                                            <p className="text-sm text-[#CBD5E1] mb-2">
                                                Above your minimum:
                                            </p>
                                            <p className={`text-3xl font-bold text-[#A7EF00] surplus-counter`}>
                                                ${surplusCounter.toLocaleString()}
                                            </p>
                                            <p className="text-xs text-[#CBD5E1] mt-2 opacity-70">
                                                Surplus split 50/50: ${(result.surplus / 2).toLocaleString()} to each side
                                            </p>
                                        </div>
                                    </GlassCard>

                                    {/* Closing Table Signature */}
                                    <GlassCard className="border-[#A7EF00]/30 bg-gradient-to-br from-[#A7EF00]/10 to-transparent">
                                        <div className="text-center py-6">
                                            <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-[#A7EF00] mb-4">
                                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#0F0518" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                                                    <polyline points="20 6 9 17 4 12"></polyline>
                                                </svg>
                                            </div>
                                            <p className="text-xl font-bold text-[#A7EF00] mb-2">
                                                Deal Closed: ${result.final.toLocaleString()}
                                            </p>
                                            <p className="text-xs text-[#CBD5E1] mb-4">
                                                The Closing Table
                                            </p>
                                            {revealLink && (
                                                <Button
                                                    variant="outline"
                                                    className="text-xs"
                                                    onClick={async () => {
                                                        try {
                                                            await navigator.clipboard.writeText(revealLink);
                                                            alert('Link copied');
                                                        } catch {
                                                            alert('Copy failed');
                                                        }
                                                    }}
                                                >
                                                    Copy Result Link
                                                </Button>
                                            )}
                                        </div>
                                    </GlassCard>
                                </div>
                            );
                        })() : (() => {
                            const cMin = ask;
                            const cMax = ask - result.gap; // Company max is below candidate min
                            const bridgeSplit = cMin + (result.gap / 2); // What the fair split would be
                            
                            return (
                                <GlassCard
                                    className={
                                        result.status === 'close'
                                            ? 'border-[#FACC15]/30'
                                            : 'border-red-500/30'
                                    }
                                >
                                    <div className="mb-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <div>
                                                <p className="text-xs text-[#CBD5E1] mb-1">Your Minimum</p>
                                                <p className="text-xl font-bold text-[#A7EF00]">${cMin.toLocaleString()}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-[#CBD5E1] mb-1">Company Maximum</p>
                                                <p className="text-xl font-bold text-[#FCD34D]">${cMax.toLocaleString()}</p>
                                            </div>
                                        </div>
                                        
                                        <div className="outcome-bar-container">
                                            {result.status === 'close' ? (
                                                <div className="outcome-bar-bridge">
                                                    <div className="outcome-bar-split-label">Within 10%</div>
                                                </div>
                                            ) : (
                                                <div className="outcome-bar-no-deal">
                                                    <div className="outcome-bar-label" style={{ left: '0%' }}>${cMin.toLocaleString()}</div>
                                                    <div className="outcome-bar-label" style={{ right: '0%' }}>${cMax.toLocaleString()}</div>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {result.status === 'close' && (
                                        <div className="bg-yellow-500/10 border border-[#FACC15]/30 p-6 rounded-xl mb-6 text-left">
                                            <p className="text-yellow-200 font-bold text-lg mb-2">
                                                You're within 10% of a deal.
                                            </p>
                                            <p className="text-yellow-100/70 text-sm mb-4">
                                                A fair split would be <strong className="text-[#FACC15]">${Math.round(bridgeSplit / 1000) * 1000}</strong>. 
                                                Consider a quick conversation to bridge the gap.
                                            </p>
                                            <Button
                                                variant="gold"
                                                className="w-full justify-center"
                                                onClick={() => {
                                                    alert(
                                                        'In a full system, this would trigger a follow-up or scheduling flow.'
                                                    );
                                                    logEvent('resolution_call_requested', {
                                                        gap: result.gap,
                                                    });
                                                }}
                                            >
                                                Schedule Resolution Call{' '}
                                                <Icons.Phone className="w-4 h-4" />
                                            </Button>
                                        </div>
                                    )}
                                    {result.status === 'fail' && (
                                        <div className="bg-red-500/10 border border-red-500/30 p-4 rounded-xl mb-6">
                                            <p className="text-red-200 font-bold">
                                                Gap too large.
                                            </p>
                                            <p className="text-red-100/70 text-sm mt-1">
                                                Your minimum is more than 10% above their maximum. This deal can't be closed automatically.
                                            </p>
                                        </div>
                                    )}
                                    <Button variant="outline" onClick={() => window.location.reload()}>
                                        Start Over
                                    </Button>
                                </GlassCard>
                            );
                        })()}
                    </div>
                );
            }
        };

        // --- RESULT VIEW ---

        const ResultView = ({ resultId }) => {
            const [step, setStep] = useState('loading');
            const [data, setData] = useState(null);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchResult = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/api/results/${encodeURIComponent(resultId)}`);
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const json = await res.json();

                        if (json.status === 'invalid') {
                            setError('This result link is not valid.');
                            setStep('error');
                        } else if (json.status === 'expired') {
                            setError('This result has expired. Ask the company to run a new Closing Table.');
                            setStep('error');
                        } else if (json.status !== 'success') {
                            setError('This result is not available.');
                            setStep('error');
                        } else {
                            setData(json);
                            setStep('ready');
                        }
                    } catch (e) {
                        setError('Failed to load result. Please check your connection.');
                        setStep('error');
                    }
                };

                if (resultId) fetchResult();
            }, [resultId]);

            if (step === 'loading') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <div className="text-[#CBD5E1]">Loading resultâ€¦</div>
                    </div>
                );
            }

            if (step === 'error') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <GlassCard className="border-red-500/30">
                            <div className="w-24 h-24 mx-auto rounded-full bg-red-500/20 flex items-center justify-center mb-8">
                                <Icons.Lock className="w-12 h-12 text-red-400" />
                            </div>
                            <h2 className="text-3xl font-bold text-[#F1F5F9] mb-4">Result Not Available</h2>
                            <p className="text-[#CBD5E1] mb-6">{error}</p>
                            <Button
                                variant="outline"
                                onClick={() => {
                                    window.location.hash = '';
                                    window.location.reload();
                                }}
                            >
                                Back to Start
                            </Button>
                        </GlassCard>
                    </div>
                );
            }

            const revealUrl = `${window.location.origin}${window.location.pathname}#result=${encodeURIComponent(resultId)}`;

            return (
                <div className="max-w-xl mx-auto animate-enter text-center">
                    <div className="w-24 h-24 mx-auto rounded-full bg-[#A7EF00] shadow-2xl shadow-[#A7EF00]/50 flex items-center justify-center mb-8" style={{ boxShadow: '0 0 40px rgba(167, 239, 0, 0.5), 0 0 80px rgba(167, 239, 0, 0.3)' }}>
                        <Icons.Handshake className="w-12 h-12 text-black" />
                    </div>

                    <h2 className="hero-heading text-5xl font-bold text-[#F1F5F9] mb-4">
                        Final Result
                    </h2>
                    <p className="hero-subtitle mb-8">
                        The Closing Table calculation result.
                    </p>

                    <div className="space-y-8">
                        {/* II. The Mechanism Run */}
                        <GlassCard className="border-[#A7EF00]/30">
                            <div className="mb-6">
                                <div className="flex justify-between items-center mb-4">
                                    <div>
                                        <p className="text-xs text-[#CBD5E1] mb-1">Candidate Minimum</p>
                                        <p className="text-xl font-bold text-[#A7EF00]">${data.min.toLocaleString()}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xs text-[#CBD5E1] mb-1">Company Maximum</p>
                                        <p className="text-xl font-bold text-[#FCD34D]">${data.max.toLocaleString()}</p>
                                    </div>
                                </div>
                                
                                <div className="outcome-bar-container">
                                    <div className="outcome-bar-fair-split">
                                        <div className="outcome-bar-split-label">50/50 Split</div>
                                    </div>
                                    <div className="outcome-bar-label" style={{ left: '0%' }}>${data.min.toLocaleString()}</div>
                                    <div className="outcome-bar-label" style={{ left: '50%', transform: 'translateX(-50%)' }}>${data.final.toLocaleString()}</div>
                                    <div className="outcome-bar-label" style={{ right: '0%' }}>${data.max.toLocaleString()}</div>
                                </div>
                            </div>
                        </GlassCard>

                        <GlassCard className="border-[#F5C04A]/30">
                            <h3 className="text-lg font-extrabold text-yellow-400 mb-4 text-left">Final Salary</h3>
                            <p className="text-6xl font-bold text-white gold-pulse mb-4 tracking-tighter financial-number">
                                ${data.final.toLocaleString()}
                            </p>
                            <div className="bg-[#A7EF00]/10 rounded-lg p-4 text-left">
                                <p className="text-xs text-[#CBD5E1]">
                                    Surplus split 50/50: ${(data.surplus / 2).toLocaleString()} to each side
                                </p>
                            </div>
                        </GlassCard>

                        {/* IV. Case Results */}
                        <div className="text-center">
                            <div className="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-[#A7EF00]/20 border-2 border-[#A7EF00]">
                                <span className="text-2xl">âœ…</span>
                                <span className="text-lg font-bold text-[#A7EF00] uppercase tracking-wider">FAIR SPLIT</span>
                            </div>
                        </div>

                        <div className="mt-8 p-4 bg-black/30 rounded-xl border border-white/10 text-left text-xs text-[#CBD5E1] space-y-1">
                            <p className="font-semibold text-[#CBD5E1]">Shareable link</p>
                            <p className="text-[11px] text-[#A7EF00] break-all">{revealUrl}</p>
                        </div>

                        <p className="text-[#CBD5E1] text-xs text-center opacity-70">
                            This is a stored result. The mechanism only runs once.
                        </p>
                    </div>
                </div>
            );
        };

        // --- MECHANISM SPEC SECTION ---


        // --- ROOT APP ---

        const App = () => {
            const [offerId, setOfferId] = useState(null);
            const [resultId, setResultId] = useState(null);
            const [isReady, setIsReady] = useState(false);

            useEffect(() => {
                const hash = window.location.hash || "";
                const resultMatch = hash.match(/#result=(.+)/);
                const offerMatch = hash.match(/#offer=(.+)/);

                if (resultMatch) {
                    setResultId(resultMatch[1]);
                } else if (offerMatch) {
                    setOfferId(offerMatch[1]);
                }
                // No hash = default to CompanyView (company creates offer first)
                setIsReady(true);
            }, []);

            if (!isReady) return null;

            return (
                <div className="app-shell min-h-screen w-full flex flex-col items-center p-4 md:p-8 bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
                    <FloatingSymbols />
                    <div className="w-full max-w-6xl relative z-10 flex-1">
                        {resultId ? (
                            <ResultView resultId={resultId} />
                        ) : offerId ? (
                            <CandidateView offerId={offerId} />
                        ) : (
                            <CompanyView />
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>

</html>
