<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A fair, private way to close salary negotiations. Double-blind mechanism that splits the difference when ranges overlap.">
    <meta name="theme-color" content="#0F0518">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    
    <title>The Closing Table</title>
    
    <!-- Resource Hints for Performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://grainy-gradients.vercel.app">
    
    <!-- Optimized Font Loading -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"></noscript>
    
    <!-- Core React Imports - Production Builds for Better Performance -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0514 0%, #1a0f2e 25%, #0f0518 50%, #1a0f2e 75%, #0a0514 100%);
            background-attachment: fixed;
            color: #E2E8F0;
            min-height: 100vh;
        }

        .glass-panel {
            background: linear-gradient(to top, rgba(20, 8, 45, 0.7) 0%, rgba(30, 10, 60, 0.5) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        }

        .gold-text-gradient {
            background: linear-gradient(to right, #FCD34D, #F59E0B);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-enter {
            animation: fade-in-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* --- APP SHELL & BACKGROUND GLOW --- */
        .app-shell {
            position: relative;
            overflow: hidden;
        }

        .app-shell::before {
            content: "";
            position: fixed;
            inset: -35%;
            background:
                radial-gradient(circle at 0% 0%, rgba(167, 239, 0, 0.14), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(232, 121, 249, 0.12), transparent 55%);
            filter: blur(40px);
            opacity: 0.9;
            animation: float-bg 26s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes float-bg {
            from {
                transform: translate3d(-24px, 14px, 0) scale(1);
            }
            to {
                transform: translate3d(28px, -20px, 0) scale(1.04);
            }
        }

        /* --- TYPOGRAPHY POLISH --- */
        .hero-heading {
            font-size: clamp(2.8rem, 4vw, 3.8rem);
            letter-spacing: -0.04em;
            line-height: 1.03;
        }

        .hero-subtitle {
            font-size: clamp(1.05rem, 1.4vw, 1.3rem);
            color: #94A3B8;
            max-width: 36rem;
            margin-inline: auto;
        }

        .section-label {
            font-size: 0.7rem;
            letter-spacing: 0.22em;
            text-transform: uppercase;
        }

        /* --- BUTTON MICRO-ANIMATION --- */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(
                120deg,
                transparent 0%,
                rgba(255, 255, 255, 0.14) 30%,
                transparent 60%
            );
            transform: translate3d(-120%, 0, 0);
            opacity: 0;
            pointer-events: none;
        }

        .btn:hover::before {
            opacity: 1;
            transform: translate3d(120%, 0, 0);
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.3s ease-out;
        }

        /* --- CARD HOVER --- */
        .card-hover {
            transition:
                transform 0.35s cubic-bezier(0.16, 1, 0.3, 1),
                box-shadow 0.35s cubic-bezier(0.16, 1, 0.3, 1),
                border-color 0.35s ease-out,
                background-color 0.35s ease-out;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.75);
            border-color: rgba(148, 163, 184, 0.55);
            background-color: rgba(30, 10, 60, 0.78);
        }

        /* --- JACKPOT NUMBER ANIMATION & SCALING --- */
        .jackpot-number {
            display: inline-block;
            transform-origin: center;
            transition:
                transform 0.22s cubic-bezier(0.22, 1, 0.36, 1),
                filter 0.22s ease-out;
        }

        .jackpot-number.jackpot-active {
            animation: jackpot-rise 0.24s cubic-bezier(0.22, 1, 0.36, 1);
            filter: drop-shadow(0 0 18px rgba(250, 250, 210, 0.35));
        }

        @keyframes jackpot-rise {
            0% {
                transform: translateY(10px) scale(1.02);
                opacity: 0.45;
            }
            55% {
                transform: translateY(-4px) scale(1.12);
                opacity: 1;
            }
            100% {
                transform: translateY(0) scale(1.06);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- API CONFIGURATION ---
        const API_BASE = 'https://closing-table-backend.onrender.com';

        // --- MECHANISM CONSTANTS ---
        const BRIDGE_ZONE_PCT = 0.10;       // 10% gap treated as "close, talk"
        const ROUNDING_GRANULARITY = 1000;  // $1,000 rounding

        // --- SIMPLE EVENT LOGGER ---
        function logEvent(type, payload = {}) {
            const event = {
                type,
                ts: new Date().toISOString(),
                ...payload,
            };
            console.log('[closing-table-event]', event);
        }

        // --- CONFIGURATION (visual only) ---
        const COLORS = {
            BG: '#0F0518',
            CARD: 'rgba(45, 20, 85, 0.4)',
            ACCENT: '#A7EF00',
            ACCENT_SEC: '#E879F9',
            GOLD: '#FCD34D',
            TEXT_MAIN: '#FFFFFF',
            TEXT_MUTED: '#94A3B8',
        };

        // --- ICONS ---
        const Icons = {
            Lock: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                    <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                </svg>
            ),
            Unlock: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                    <path d="M7 11V7a5 5 0 0 1 9.9-1" />
                </svg>
            ),
            Mail: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                    <polyline points="22,6 12,13 2,6" />
                </svg>
            ),
            Check: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <polyline points="20 6 9 17 4 12" />
                </svg>
            ),
            Copy: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                </svg>
            ),
            ArrowRight: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <line x1="5" y1="12" x2="19" y2="12" />
                    <polyline points="12 5 19 12 12 19" />
                </svg>
            ),
            Handshake: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <path d="m11 17 2 2a2 2 0 1 0 2.8-2.8l-6-6-2 2 2 2 2 2a2 2 0 1 1-2.8 2.8L11 17Z" />
                    <path d="m22 11-2-2-6 6-2-2-6 6-2-2a2 2 0 0 1 2.8-2.8l6 6 2-2 6-6 2 2 2 2a2 2 0 0 1 2.8 2.8l-2 2Z" />
                </svg>
            ),
            Phone: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
                </svg>
            ),
            Shield: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
            ),
            TrendingUp: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
                    <polyline points="18 7 22 7 22 11" />
                </svg>
            ),
            Terminal: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <polyline points="4 17 10 11 4 5" />
                    <line x1="12" y1="19" x2="20" y2="19" />
                </svg>
            ),
            Info: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" strokeWidth="2"
                     strokeLinecap="round" strokeLinejoin="round"
                     className={className}>
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
            ),
        };

        // --- COMPONENTS ---

        const Slider = ({ value, onChange, min, max, step }) => {
            const percent = ((value - min) / (max - min)) * 100;
            return (
                <div className="relative w-full h-12 flex items-center group">
                    <div className="absolute w-full h-2 bg-gradient-to-r from-gray-800 via-gray-700 to-gray-600 rounded-full overflow-hidden">
                        <div
                            className="h-full bg-gradient-to-r from-lime-400 to-lime-500"
                            style={{ width: `${percent}%` }}
                        />
                    </div>
                    <input
                        type="range"
                        min={min}
                        max={max}
                        step={step}
                        value={value}
                        onChange={onChange}
                        aria-label={`Slider value: ${value}`}
                        className="absolute w-full h-full opacity-0 cursor-pointer z-20"
                    />
                    <div
                        className="absolute h-7 w-7 bg-white border-2 border-lime-400 rounded-full shadow-lg shadow-lime-400/50 z-10 pointer-events-none transition-all duration-150 group-active:scale-110"
                        style={{ 
                            left: `calc(${percent}% - 14px)`,
                            boxShadow: '0 0 12px rgba(167, 239, 0, 0.6), 0 2px 8px rgba(0, 0, 0, 0.3)'
                        }}
                    >
                        <div className="absolute inset-0 flex items-center justify-center">
                            <div className="w-2 h-2 bg-lime-400 rounded-full"></div>
                        </div>
                    </div>
                </div>
            );
        };

        const Button = ({ children, onClick, disabled, variant = 'primary', className = '' }) => {
            const baseStyle =
                "btn relative px-8 py-4 rounded-xl font-bold text-lg transform transition-all duration-200 " +
                "flex items-center justify-center gap-3 " +
                "hover:-translate-y-0.5 active:translate-y-0 active:scale-95 " +
                "disabled:opacity-50 disabled:cursor-not-allowed " +
                "focus:outline-none focus-visible:ring-2 focus-visible:ring-lime-400/80 " +
                "focus-visible:ring-offset-2 focus-visible:ring-offset-[#0F0518]";

            const variants = {
                primary: "bg-lime-400 text-black hover:bg-lime-300 shadow-lg shadow-lime-400/30 hover:shadow-2xl hover:shadow-lime-400/40",
                secondary: "bg-white/10 text-white border border-white/10 hover:bg-white/20 backdrop-blur-md",
                outline: "border-2 border-gray-700 text-gray-300 hover:border-lime-400 hover:text-lime-400",
                gold: "bg-gradient-to-r from-amber-300 to-yellow-500 text-black shadow-lg shadow-amber-400/25 hover:shadow-2xl hover:shadow-amber-400/45",
                danger: "bg-red-500 text-white shadow-lg shadow-red-500/20 hover:bg-red-400",
                ai: "bg-emerald-900/40 text-emerald-400 border border-emerald-700 hover:bg-emerald-900/60 shadow-md shadow-emerald-900/50",
            };

            return (
                <button
                    onClick={onClick}
                    disabled={disabled}
                    aria-disabled={disabled}
                    className={`${baseStyle} ${variants[variant]} ${className}`}
                >
                    {children}
                </button>
            );
        };

        const GlassCard = ({ children, className = '' }) => (
            <div className={`glass-panel card-hover rounded-3xl p-8 md:p-12 shadow-2xl ${className}`}>
                {children}
            </div>
        );

        const BandIndicator = ({ value }) => {
            const bandSize = 10000;
            const lower = Math.floor(value / bandSize) * bandSize;
            const upper = lower + bandSize;

            return (
                <div className="flex justify-center mt-2">
                    <span className="text-xs font-medium text-gray-600 uppercase tracking-wider border border-gray-700/50 px-3 py-1 rounded-full">
                        Band: ${lower.toLocaleString()} - ${upper.toLocaleString()}
                    </span>
                </div>
            );
        };

        const SplitDiagram = () => (
            <div className="my-8 p-6 bg-white/5 rounded-2xl border border-white/10">
                <h3 className="text-lime-400 font-bold mb-4 text-sm tracking-widest uppercase">
                    The Fair Split Logic
                </h3>
                <div className="relative h-16 w-full flex items-center">
                    <div className="absolute w-full h-2 bg-gray-700 rounded-full"></div>
                    <div className="absolute left-1/4 right-1/4 h-2 bg-gradient-to-r from-lime-400 to-yellow-400 rounded-full opacity-50 animate-pulse"></div>
                    <div className="absolute left-1/4 top-[-25px] flex flex-col items-center">
                        <span className="text-xs font-bold text-white mb-1">You</span>
                        <div className="w-4 h-4 bg-lime-400 rounded-full border-4 border-gray-900"></div>
                    </div>
                    <div className="absolute left-1/2 top-4 flex flex-col items-center">
                        <div className="h-6 w-px bg-white/20 mb-1"></div>
                        <span className="text-xs font-bold text-yellow-400">Split Surplus</span>
                    </div>
                    <div className="absolute right-1/4 top-[-25px] flex flex-col items-center">
                        <span className="text-xs font-bold text-gray-400 mb-1">Company</span>
                        <div className="w-4 h-4 bg-gray-600 rounded-full border-4 border-gray-900"></div>
                    </div>
                </div>
                <p className="text-gray-400 text-sm mt-4 text-center">
                    We calculate the surplus overlap and split it 50/50. The final number is rounded to protect privacy.
                </p>
            </div>
        );

        // --- COMPANY VIEW ---

        const CompanyView = () => {
            const [budget, setBudget] = useState(140000);
            const [email, setEmail] = useState('');
            const [link, setLink] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [budgetAnimating, setBudgetAnimating] = useState(false);

            const COMPANY_MIN = 50000;
            const COMPANY_MAX = 300000;

            const budgetScale = (() => {
                const norm = Math.min(
                    1,
                    Math.max(0, (budget - COMPANY_MIN) / (COMPANY_MAX - COMPANY_MIN))
                );
                return 0.98 + norm * 0.18; // grows up to ~1.16 near the top
            })();

            const generateLink = async () => {
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(`${API_BASE}/api/offers`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ max: budget, email }),
                    });

                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (jsonErr) {
                            throw new Error(`HTTP ${response.status}: Failed to create offer`);
                        }
                        throw new Error(errorData.error || 'Failed to create offer');
                    }

                    let responseData;
                    try {
                        responseData = await response.json();
                    } catch (jsonErr) {
                        throw new Error('Invalid response from server');
                    }
                    const { offerId } = responseData;
                    const newLink = `${window.location.origin}${window.location.pathname}#offer=${offerId}`;
                    setLink(newLink);

                    logEvent('offer_created', {
                        max: budget,
                        email,
                        offerId,
                    });
                } catch (err) {
                    setError(err.message);
                    logEvent('offer_create_error', { error: err.message });
                } finally {
                    setLoading(false);
                }
            };

            const copyLink = async () => {
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(link);
                        alert("Link copied to clipboard");
                        logEvent('offer_link_copied', { linkLength: link.length });
                        return;
                    }
                } catch (err) {
                    console.warn('Clipboard API failed, trying fallback:', err);
                }
                
                const textarea = document.createElement('textarea');
                textarea.value = link;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                textarea.setAttribute('aria-hidden', 'true');
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert("Link copied to clipboard");
                    logEvent('offer_link_copied', { linkLength: link.length });
                } catch (err) {
                    console.error('Could not copy text: ', err);
                }
                document.body.removeChild(textarea);
            };

            const handleBudgetChange = (e) => {
                const value = parseInt(e.target.value, 10);
                if (isNaN(value)) return;

                setBudget(prev => {
                    if (value !== prev) {
                        setBudgetAnimating(true);
                        setTimeout(() => setBudgetAnimating(false), 200);
                    }
                    return value;
                });
            };

            if (link) {
                return (
                    <div className="max-w-2xl mx-auto animate-enter text-center">
                        <div className="mb-8 inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-lime-400 to-green-500 shadow-2xl shadow-lime-400/30 mx-auto">
                            <Icons.Lock className="w-10 h-10 text-black" />
                        </div>
                        <h1 className="text-4xl md:text-6xl font-bold mb-6 text-white">
                            Offer Secured.
                        </h1>
                        <p className="text-xl text-gray-300 mb-10 leading-relaxed">
                            We've locked your limit of <strong className="text-lime-400">${budget.toLocaleString()}</strong>.
                            <br />Share this link with the candidate to run the Closing Table.
                        </p>

                        <GlassCard className="mb-8">
                            <div className="bg-black/30 p-4 rounded-xl border border-white/10 flex items-center justify-between gap-4 mb-6">
                                <code className="text-lime-400 truncate flex-1 text-left font-mono text-sm">
                                    {link}
                                </code>
                                <button
                                    onClick={copyLink}
                                    aria-label="Copy link to clipboard"
                                    className="p-2 hover:bg-white/10 rounded-lg transition"
                                >
                                    <Icons.Copy className="w-5 h-5 text-gray-400" />
                                </button>
                            </div>
                            <div className="grid gap-4">
                                <Button onClick={copyLink} variant="gold">
                                    Copy Link & Close
                                </Button>
                                <Button
                                    variant="secondary"
                                    onClick={() => {
                                        window.location.hash = `#offer=${link.split('offer=')[1]}`;
                                        window.location.reload();
                                    }}
                                >
                                    <Icons.ArrowRight className="w-5 h-5" />
                                    Preview Candidate View
                                </Button>
                            </div>
                        </GlassCard>
                    </div>
                );
            }

            return (
                <div className="max-w-2xl mx-auto animate-enter">
                    <div className="text-center mb-12">
                        <h1 className="hero-heading text-4xl md:text-6xl font-bold mb-6" style={{ textShadow: '0 0 20px rgba(252, 211, 77, 0.3)' }}>
                            <span style={{ fontSize: '1.1em' }}>The</span>{' '}
                            <span className="gold-text-gradient" style={{ fontWeight: '800', fontSize: '1.15em' }}>Closing</span>{' '}
                            <span style={{ fontSize: '1.1em' }}>Table</span>
                        </h1>
                        <p className="hero-subtitle mt-2">
                            A fair, private way to close the deal. Set your walk-away number.
                            If they fit within it, the mechanism closes the gap for you.
                        </p>
                    </div>

                    <GlassCard>
                        <label className="block text-xs font-bold text-lime-400 uppercase tracking-widest mb-4">
                            Maximum Offer Limit (Private)
                        </label>

                        <div className="flex items-baseline justify-center mb-2">
                            <span className="text-gray-500 text-4xl font-bold mr-2">$</span>
                            <span
                                className={
                                    "text-7xl font-bold text-white tracking-tighter jackpot-number " +
                                    (budgetAnimating ? "jackpot-active" : "")
                                }
                                style={{ transform: `scale(${budgetScale})` }}
                            >
                                {budget.toLocaleString()}
                            </span>
                        </div>
                        <BandIndicator value={budget} />

                        <div className="mb-12 px-4 mt-8">
                            <Slider
                                min={50000}
                                max={300000}
                                step={5000}
                                value={budget}
                                onChange={handleBudgetChange}
                            />
                            <div className="flex justify-between mt-2 text-xs text-gray-400 font-semibold uppercase tracking-wider" style={{ fontFamily: "'Plus Jakarta Sans', sans-serif", letterSpacing: '0.1em' }}>
                                <span>Conservative</span>
                                <span>Aggressive</span>
                            </div>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">
                                    Where to send the deal? (for your own reference)
                                </label>
                                <div className="relative">
                                    <Icons.Mail className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" />
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="you@company.com"
                                        aria-label="Company email address"
                                        autoComplete="email"
                                        className="w-full bg-black/30 border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-white placeholder-gray-600 focus:outline-none focus:border-lime-400 focus:ring-2 focus:ring-lime-400/30 hover:border-lime-400/50 transition-all duration-200"
                                    />
                                </div>
                                <p className="mt-2 text-xs text-gray-500">
                                    This address is just stored with the offer for your reference. The tool does not send any automatic emails.
                                </p>
                            </div>

                            {error && (
                                <div className="bg-red-500/10 border border-red-500/30 p-4 rounded-xl">
                                    <p className="text-red-200 text-sm">{error}</p>
                                </div>
                            )}

                            <Button onClick={generateLink} disabled={!email || loading} variant="gold" className="w-full">
                                <Icons.Lock className="w-6 h-6" />
                                {loading ? 'Creating Offer...' : 'Lock Budget & Create Link'}
                            </Button>

                            <p className="text-center text-xs text-gray-500">
                                Offers expire after 24 hours and are not stored permanently.
                            </p>
                        </div>
                    </GlassCard>
                </div>
            );
        };

        // --- CANDIDATE VIEW ---

        const CandidateView = ({ offerId }) => {
            const [ask, setAsk] = useState(120000);
            const [email, setEmail] = useState('');
            const [step, setStep] = useState('loading');
            const [result, setResult] = useState(null);
            const [marketData, setMarketData] = useState(null);
            const [loadingMarket, setLoadingMarket] = useState(false);
            const [offerStatus, setOfferStatus] = useState(null);
            const [error, setError] = useState(null);
            const marketDataTimeoutRef = useRef(null);
            const [askAnimating, setAskAnimating] = useState(false);

            const ASK_MIN = 80000;
            const ASK_MAX = 250000;

            const askScale = (() => {
                const norm = Math.min(
                    1,
                    Math.max(0, (ask - ASK_MIN) / (ASK_MAX - ASK_MIN))
                );
                return 0.98 + norm * 0.18;
            })();

            // Check offer status on load
            useEffect(() => {
                // Validate offerId before making API call
                if (!offerId || typeof offerId !== 'string' || offerId.trim() === '') {
                    setError('Invalid offer link.');
                    setStep('error');
                    return;
                }

                const checkOffer = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/offers/${offerId}`);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        let data;
                        try {
                            data = await response.json();
                        } catch (jsonErr) {
                            throw new Error('Invalid response from server');
                        }
                        
                        if (data.status === 'invalid') {
                            setError('This offer link is not valid. It may have been typed incorrectly.');
                            setStep('error');
                            logEvent('offer_check_invalid', { offerId });
                        } else if (data.status === 'expired') {
                            setError('This offer has expired. Ask the company to generate a new link.');
                            setStep('error');
                            logEvent('offer_check_expired', { offerId });
                        } else if (data.status === 'used') {
                            setError('This link has already been used once. The mechanism only runs a single time per offer.');
                            setStep('error');
                            logEvent('offer_check_used', { offerId });
                        } else {
                            setOfferStatus('ok');
                            setStep('intro');
                            logEvent('offer_viewed', { offerId, status: 'ok' });
                        }
                    } catch (err) {
                        setError('Failed to load offer. Please check your connection.');
                        setStep('error');
                        logEvent('offer_check_error', { offerId, error: err.message });
                    }
                };

                if (offerId) {
                    checkOffer();
                }
            }, [offerId]);

            const handleAskChange = (e) => {
                const value = parseInt(e.target.value, 10);
                if (isNaN(value)) return;

                setAsk(prev => {
                    if (value !== prev) {
                        setAskAnimating(true);
                        setTimeout(() => setAskAnimating(false), 200);
                    }
                    return value;
                });
            };

            const fetchMarketData = () => {
                if (loadingMarket || marketData) return;
                setLoadingMarket(true);
                // Use a reasonable default for mock data (actual max not available from API)
                // In a real system, this would use the actual offer max from the API
                const defaultMax = 120000;
                // Clear any existing timeout
                if (marketDataTimeoutRef.current) {
                    clearTimeout(marketDataTimeoutRef.current);
                }
                marketDataTimeoutRef.current = setTimeout(() => {
                    // Mock market data - in real system this would come from API
                    const mockMarketValue =
                        Math.round((defaultMax * 0.95 + ROUNDING_GRANULARITY) / ROUNDING_GRANULARITY) *
                        ROUNDING_GRANULARITY;
                    setMarketData(mockMarketValue);
                    setLoadingMarket(false);
                    logEvent('market_data_shown', { suggested: mockMarketValue });
                    marketDataTimeoutRef.current = null;
                }, 1500);
            };

            // Cleanup timeout on unmount
            useEffect(() => {
                return () => {
                    if (marketDataTimeoutRef.current) {
                        clearTimeout(marketDataTimeoutRef.current);
                    }
                };
            }, []);

            const submit = async () => {
                // Validate offerId before submitting
                if (!offerId || typeof offerId !== 'string' || offerId.trim() === '') {
                    setError('Invalid offer link.');
                    setStep('error');
                    return;
                }

                setStep('submitting');
                try {
                    const response = await fetch(`${API_BASE}/api/offers/${offerId}/submit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ min: ask, email }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    let data;
                    try {
                        data = await response.json();
                    } catch (jsonErr) {
                        throw new Error('Invalid response from server');
                    }

                    if (data.status === 'invalid') {
                        setError('This offer link is not valid. It may have been typed incorrectly.');
                        setStep('error');
                        logEvent('submit_rejected', { offerId, status: data.status });
                        return;
                    } else if (data.status === 'expired') {
                        setError('This offer has expired. Ask the company to generate a new link.');
                        setStep('error');
                        logEvent('submit_rejected', { offerId, status: data.status });
                        return;
                    } else if (data.status === 'used') {
                        setError('This link has already been used once. The mechanism only runs a single time per offer.');
                        setStep('error');
                        logEvent('submit_rejected', { offerId, status: data.status });
                        return;
                    }

                    setResult(data);
                    setStep('result');

                    logEvent('candidate_submitted', {
                        offerId,
                        min: ask,
                        status: data.status,
                        surplus: data.surplus,
                        gap: data.gap,
                        emailProvided: !!email,
                    });
                } catch (err) {
                    setError('Failed to submit. Please try again.');
                    setStep('error');
                    logEvent('submit_error', { offerId, error: err.message });
                }
            };

            if (step === 'loading') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <div className="text-gray-400">Loading offer...</div>
                    </div>
                );
            }

            if (step === 'error') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <GlassCard className="border-red-500/30">
                            <div className="w-24 h-24 mx-auto rounded-full bg-red-500/20 flex items-center justify-center mb-8">
                                <Icons.Lock className="w-12 h-12 text-red-400" />
                            </div>
                            <h2 className="text-3xl font-bold text-white mb-4">Unable to Load Offer</h2>
                            <p className="text-gray-300 mb-6">{error}</p>
                            <Button variant="outline" onClick={() => {
                                window.location.hash = '';
                                window.location.reload();
                            }}>
                                Back to Start
                            </Button>
                        </GlassCard>
                    </div>
                );
            }

            if (step === 'submitting') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <div className="text-gray-400">Processing your submission...</div>
                    </div>
                );
            }

            if (step === 'intro') {
                return (
                    <div className="max-w-3xl mx-auto animate-enter">
                        <div className="text-center mb-12">
                            <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 text-sm text-lime-400 font-bold mb-6">
                                <Icons.Lock className="w-4 h-4" /> Single-Step, Private Mechanism
                            </div>
                            <h1 className="hero-heading text-5xl md:text-7xl font-bold mb-6 text-white">
                                Fair, Fast, Private Negotiation
                            </h1>
                            <p className="hero-subtitle text-xl md:text-2xl max-w-2xl mx-auto">
                                The company has set a maximum they're willing to pay.
                                <br />
                                You set your minimum. If your ranges overlap, the tool splits the surplus
                                and closes the deal in a single step.
                            </p>
                            <p className="mt-4 text-xs text-gray-500">
                                For broader compensation context, see the{' '}
                                <a
                                    href="https://dccr.dragonfly.xyz/report"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="underline text-lime-400 hover:text-lime-300"
                                >
                                    Dragonfly DCCR report
                                </a>.
                            </p>
                        </div>

                        <GlassCard className="mb-8">
                            <div className="grid md:grid-cols-2 gap-12 items-center">
                                <div>
                                    <h3 className="text-2xl font-bold text-white mb-4">How it works</h3>
                                    <ul className="space-y-6">
                                        <li className="flex gap-4">
                                            <div className="w-8 h-8 rounded-full bg-lime-400/10 flex items-center justify-center shrink-0">
                                                <span className="font-bold text-lime-400">1</span>
                                            </div>
                                            <p className="text-gray-300">
                                                They set a max limit. You never see it in this interface.
                                            </p>
                                        </li>
                                        <li className="flex gap-4">
                                            <div className="w-8 h-8 rounded-full bg-lime-400/10 flex items-center justify-center shrink-0">
                                                <span className="font-bold text-lime-400">2</span>
                                            </div>
                                            <p className="text-gray-300">
                                                You set your minimum. They never see it directly.
                                            </p>
                                        </li>
                                        <li className="flex gap-4">
                                            <div className="w-8 h-8 rounded-full bg-lime-400/10 flex items-center justify-center shrink-0">
                                                <span className="font-bold text-lime-400">3</span>
                                            </div>
                                            <p className="text-gray-300">
                                                If there's overlap, we{' '}
                                                <strong>split the extra money</strong> 50/50, round to the nearest
                                                thousand, and show the final base salary.
                                            </p>
                                        </li>
                                    </ul>
                                </div>
                                <div className="bg-black/20 p-6 rounded-2xl border border-white/5">
                                    <SplitDiagram />
                                </div>
                            </div>
                            <div className="mt-10 text-center">
                                <Button onClick={() => setStep('input')} className="w-full md:w-auto">
                                    Take Your Seat at the Table{' '}
                                    <Icons.ArrowRight className="w-5 h-5" />
                                </Button>
                            </div>
                        </GlassCard>
                    </div>
                );
            }

            if (step === 'input') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <h2 className="text-3xl font-bold text-white mb-2">What is your minimum?</h2>
                        <p className="text-gray-400 mb-10">
                            The lowest base salary you would happily sign for today.
                        </p>

                        <GlassCard>
                            <div className="flex items-baseline justify-center mb-2">
                                <span className="text-gray-500 text-4xl font-bold mr-2">$</span>
                                <span
                                    className={
                                        "text-7xl font-bold text-white tracking-tighter jackpot-number " +
                                        (askAnimating ? "jackpot-active" : "")
                                    }
                                    style={{ transform: `scale(${askScale})` }}
                                >
                                    {ask.toLocaleString()}
                                </span>
                            </div>
                            <BandIndicator value={ask} />

                            <div className="mb-8 mt-8">
                                <Slider
                                    min={80000}
                                    max={250000}
                                    step={1000}
                                    value={ask}
                                    onChange={handleAskChange}
                                />
                            </div>

                            <div className="mb-8 p-4 bg-white/5 rounded-xl border border-white/10">
                                <div className="flex justify-between items-center">
                                    <span className="text-sm font-bold text-gray-400">
                                        Not sure what to ask?
                                    </span>
                                    <button
                                        onClick={fetchMarketData}
                                        disabled={loadingMarket || marketData}
                                        aria-label="Check market data for salary guidance"
                                        aria-busy={loadingMarket}
                                        className="text-xs font-bold text-lime-400 hover:text-lime-300 uppercase tracking-widest disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {loadingMarket ? 'Checking...' : 'Check Market Data'}
                                    </button>
                                </div>
                                {marketData && (
                                    <div className="mt-3 text-left animate-enter">
                                        <p className="text-sm text-gray-300">
                                            For this prototype, we show a rough, illustrative guidance number of{' '}
                                            <strong className="text-white">
                                                ${marketData.toLocaleString()}
                                            </strong>
                                            {' '}to help you sanity-check your ask. It is not a firm market quote.
                                            {' '}
                                            <a
                                                href="https://dccr.dragonfly.xyz/report"
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="underline text-lime-400 hover:text-lime-300"
                                            >
                                                Read the Dragonfly DCCR report
                                            </a>
                                            {' '}for deeper benchmark context.
                                            <button
                                                onClick={() => setAsk(marketData)}
                                                aria-label={`Set minimum salary to ${marketData.toLocaleString()}`}
                                                className="ml-2 underline text-lime-400 hover:text-lime-300 transition-colors"
                                            >
                                                Use this
                                            </button>
                                        </p>
                                    </div>
                                )}
                            </div>

                            <div className="space-y-6">
                                <div className="text-left">
                                    <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">
                                        Where should the outcome go?
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="you@email.com"
                                        aria-label="Candidate email address"
                                        autoComplete="email"
                                        className="w-full bg-black/30 border border-white/10 rounded-2xl py-4 px-4 text-white focus:outline-none focus:border-lime-400 focus:ring-2 focus:ring-lime-400/30 hover:border-lime-400/50 transition-all duration-200"
                                    />
                                    <p className="mt-2 text-xs text-gray-500">
                                        For this prototype, your email is only shown in the explanation text. No messages are sent automatically.
                                    </p>
                                </div>

                                <Button onClick={submit} disabled={!email} className="w-full">
                                    Submit Final Number
                                </Button>
                            </div>
                        </GlassCard>
                    </div>
                );
            }

            if (step === 'result') {
                const isSuccess = result.status === 'success';
                const resultLink = result.resultId
                    ? `${window.location.origin}${window.location.pathname}#result=${result.resultId}`
                    : null;

                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <div
                            className={`w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-8 shadow-2xl ${
                                isSuccess
                                    ? 'bg-lime-400 shadow-lime-400/50'
                                    : result.status === 'close'
                                    ? 'bg-yellow-500 shadow-yellow-500/50'
                                    : 'bg-red-500 shadow-red-500/50'
                            }`}
                        >
                            {isSuccess ? (
                                <Icons.Handshake className="w-12 h-12 text-black" />
                            ) : result.status === 'close' ? (
                                <Icons.Phone className="w-12 h-12 text-black" />
                            ) : (
                                <Icons.Lock className="w-12 h-12 text-white" />
                            )}
                        </div>

                        <h2 className="text-5xl font-bold text-white mb-6">
                            {isSuccess
                                ? 'Deal Accepted!'
                                : result.status === 'close'
                                ? 'Gap Detected'
                                : 'No Deal.'}
                        </h2>

                        {isSuccess ? (
                            <GlassCard className="border-lime-500/30">
                                <p className="text-gray-400 text-lg mb-2">
                                    Final Binding Offer (from the mechanism)
                                </p>
                                <p className="text-7xl font-bold text-lime-400 mb-4 tracking-tighter">
                                    ${result.final.toLocaleString()}
                                </p>
                                <div className="bg-lime-400/10 rounded-lg p-4 inline-block">
                                    <p className="text-lime-200 text-sm font-medium">
                                        Rounded for privacy. Includes a{' '}
                                        <strong>
                                            ${result.surplus.toLocaleString()}
                                        </strong>{' '}
                                        fair split of the surplus between your minimum and their maximum.
                                    </p>
                                </div>
                                <p className="mt-8 text-gray-400 text-sm">
                                    In a future full system, this is where an official offer workflow (emails, docs)
                                    would kick in using the final number and your email: {email}. This prototype does not send emails automatically.
                                </p>
                                {resultLink && (
                                    <div className="mt-4 bg-white/5 rounded-lg p-3 text-xs text-gray-400 break-all">
                                        Shareable outcome link (valid for ~24 hours):<br />
                                        <span className="text-lime-400">{resultLink}</span>
                                    </div>
                                )}
                            </GlassCard>
                        ) : (
                            <GlassCard
                                className={
                                    result.status === 'close'
                                        ? 'border-yellow-500/30'
                                        : 'border-red-500/30'
                                }
                            >
                                <p className="text-gray-300 text-lg mb-6">
                                    Your minimum was higher than the company's maximum budget.
                                </p>
                                {result.status === 'close' && (
                                    <div className="bg-yellow-500/10 border border-yellow-500/30 p-6 rounded-xl mb-6 text-left">
                                        <p className="text-yellow-200 font-bold text-xl mb-2">
                                            You are very close (within 10%).
                                        </p>
                                        <p className="text-yellow-100/70 text-sm mb-4">
                                            The automated tool couldn't bridge the gap, but you are close enough
                                            that a short human conversation is highly recommended.
                                        </p>
                                        <Button
                                            variant="gold"
                                            className="w-full justify-center"
                                            onClick={() => {
                                                alert(
                                                    'In a full system, this would trigger a follow-up or scheduling flow.'
                                                );
                                                logEvent('resolution_call_requested', {
                                                    gap: result.gap,
                                                });
                                            }}
                                        >
                                            Schedule Resolution Call{' '}
                                            <Icons.Phone className="w-4 h-4" />
                                        </Button>
                                    </div>
                                )}
                                {result.status === 'fail' && (
                                    <div className="bg-red-500/10 border border-red-500/30 p-4 rounded-xl mb-6">
                                        <p className="text-red-200 font-bold">
                                            Gap too large (&gt;10%).
                                        </p>
                                        <p className="text-red-100/70 text-sm mt-1">
                                            The ranges don't overlap enough for this mechanism to close a deal. It
                                            may make sense to restart the search.
                                        </p>
                                    </div>
                                )}
                                <Button variant="outline" onClick={() => window.location.reload()}>
                                    Start Over
                                </Button>
                            </GlassCard>
                        )}
                    </div>
                );
            }
        };

        // --- RESULT VIEW ---

        const ResultView = ({ resultId }) => {
            const [step, setStep] = useState('loading');
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);

            useEffect(() => {
                const loadResult = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/api/results/${resultId}`);
                        if (!res.ok) {
                            throw new Error(`HTTP ${res.status}`);
                        }
                        const data = await res.json();

                        if (data.status === 'invalid') {
                            setError('This result link is not valid. It may have been typed incorrectly.');
                            setStep('error');
                            logEvent('result_view_invalid', { resultId });
                            return;
                        }

                        if (data.status === 'expired') {
                            setError('This result has expired. Ask the company to generate a new link.');
                            setStep('error');
                            logEvent('result_view_expired', { resultId });
                            return;
                        }

                        // status === 'ok'
                        setResult(data.result); // { status, final, surplus, gap }
                        setStep('result');
                        logEvent('result_view_ok', { resultId, status: data.result.status });
                    } catch (err) {
                        setError('Failed to load result. Please try again or contact the company.');
                        setStep('error');
                        logEvent('result_view_error', { resultId, error: err.message });
                    }
                };

                if (resultId) loadResult();
            }, [resultId]);

            if (step === 'loading') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <div className="text-gray-400">Loading outcome...</div>
                    </div>
                );
            }

            if (step === 'error') {
                return (
                    <div className="max-w-xl mx-auto animate-enter text-center">
                        <GlassCard className="border-red-500/30">
                            <div className="w-24 h-24 mx-auto rounded-full bg-red-500/20 flex items-center justify-center mb-8">
                                <Icons.Lock className="w-12 h-12 text-red-400" />
                            </div>
                            <h2 className="text-3xl font-bold text-white mb-4">Unable to Show Outcome</h2>
                            <p className="text-gray-300 mb-6">{error}</p>
                            <Button
                                variant="outline"
                                onClick={() => {
                                    window.location.hash = '';
                                    window.location.reload();
                                }}
                            >
                                Back to Start
                            </Button>
                        </GlassCard>
                    </div>
                );
            }

            const isSuccess = result.status === 'success';

            return (
                <div className="max-w-xl mx-auto animate-enter text-center">
                    <div
                        className={`w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-8 shadow-2xl ${
                            isSuccess
                                ? 'bg-lime-400 shadow-lime-400/50'
                                : result.status === 'close'
                                ? 'bg-yellow-500 shadow-yellow-500/50'
                                : 'bg-red-500 shadow-red-500/50'
                        }`}
                    >
                        {isSuccess ? (
                            <Icons.Handshake className="w-12 h-12 text-black" />
                        ) : result.status === 'close' ? (
                            <Icons.Phone className="w-12 h-12 text-black" />
                        ) : (
                            <Icons.Lock className="w-12 h-12 text-white" />
                        )}
                    </div>

                    <h2 className="text-5xl font-bold text-white mb-6">
                        {isSuccess
                            ? 'Deal Accepted!'
                            : result.status === 'close'
                            ? 'Gap Detected'
                            : 'No Deal.'}
                    </h2>

                    {isSuccess ? (
                        <GlassCard className="border-lime-500/30">
                            <p className="text-gray-400 text-lg mb-2">
                                Final Binding Offer (from the mechanism)
                            </p>
                            <p className="text-7xl font-bold text-lime-400 mb-4 tracking-tighter">
                                ${result.final.toLocaleString()}
                            </p>
                            <div className="bg-lime-400/10 rounded-lg p-4 inline-block">
                                <p className="text-lime-200 text-sm font-medium">
                                    Rounded for privacy. Includes a{' '}
                                    <strong>${result.surplus.toLocaleString()}</strong> fair split of the
                                    surplus between your minimum and their maximum.
                                </p>
                            </div>
                            <p className="mt-8 text-gray-400 text-sm">
                                This link only shows the outcome from this single run of the mechanism.
                            </p>
                        </GlassCard>
                    ) : (
                        <GlassCard
                            className={
                                result.status === 'close'
                                    ? 'border-yellow-500/30'
                                    : 'border-red-500/30'
                            }
                        >
                            <p className="text-gray-300 text-lg mb-6">
                                Your minimum was higher than the company's maximum budget.
                            </p>
                            {result.status === 'close' && (
                                <div className="bg-yellow-500/10 border border-yellow-500/30 p-6 rounded-xl mb-6 text-left">
                                    <p className="text-yellow-200 font-bold text-xl mb-2">
                                        You are very close (within 10%).
                                    </p>
                                    <p className="text-yellow-100/70 text-sm mb-4">
                                        The automated tool couldn't bridge the gap, but you are close enough
                                        that a short human conversation is highly recommended.
                                    </p>
                                </div>
                            )}
                            {result.status === 'fail' && (
                                <div className="bg-red-500/10 border border-red-500/30 p-4 rounded-xl mb-6">
                                    <p className="text-red-200 font-bold">Gap too large (&gt;10%).</p>
                                    <p className="text-red-100/70 text-sm mt-1">
                                        The ranges don't overlap enough for this mechanism to close a deal. It
                                        may make sense to restart the search.
                                    </p>
                                </div>
                            )}
                            <Button
                                variant="outline"
                                onClick={() => {
                                    window.location.hash = '';
                                    window.location.reload();
                                }}
                            >
                                Back to Start
                            </Button>
                        </GlassCard>
                    )}
                </div>
            );
        };

        // --- ROOT APP ---

        const App = () => {
            const [offerId, setOfferId] = useState(null);
            const [resultId, setResultId] = useState(null);
            const [isReady, setIsReady] = useState(false);

            useEffect(() => {
                const hash = window.location.hash || '';

                const resultMatch = hash.match(/#result=(.+)/);
                const offerMatch = hash.match(/#offer=(.+)/);

                if (resultMatch) {
                    setResultId(resultMatch[1]);
                    logEvent('app_loaded', { mode: 'result', resultId: resultMatch[1] });
                } else if (offerMatch) {
                    setOfferId(offerMatch[1]);
                    logEvent('app_loaded', { mode: 'candidate', offerId: offerMatch[1] });
                } else {
                    logEvent('app_loaded', { mode: 'company' });
                }

                setIsReady(true);
            }, []);

            if (!isReady) return null;

            return (
                <div className="app-shell min-h-screen w-full flex items-center justify-center p-4 md:p-8 bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
                    <div className="w-full max-w-6xl relative z-10">
                        {resultId ? (
                            <ResultView resultId={resultId} />
                        ) : offerId ? (
                            <CandidateView offerId={offerId} />
                        ) : (
                            <CompanyView />
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>

</html>
