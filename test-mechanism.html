<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanism Tests</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 { color: #4ade80; }
        .test { 
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #666;
            background: #2a2a2a;
        }
        .pass { border-left-color: #4ade80; }
        .fail { border-left-color: #f87171; }
        .test-name { font-weight: bold; color: #94a3b8; }
        .result { margin-top: 5px; }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        button {
            background: #4ade80;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        button:hover { background: #22c55e; }
    </style>
</head>
<body>
    <h1>Mechanism Test Suite</h1>
    <button onclick="runTests()">Run Tests</button>
    <div id="results"></div>
    <div id="summary" class="summary" style="display: none;"></div>

    <script>
        // Mechanism function (same as mechanism.js)
        function computeOutcome(cMax, cMin) {
            const BRIDGE_ZONE_PCT = 0.10;
            const ROUNDING_GRANULARITY = 1000;

            if (cMin <= cMax) {
                const surplus = cMax - cMin;
                const rawFinal = cMin + surplus / 2;
                const final = Math.round(rawFinal / ROUNDING_GRANULARITY) * ROUNDING_GRANULARITY;
                return { status: 'success', final, surplus, gap: null };
            } else if (cMin <= cMax * (1 + BRIDGE_ZONE_PCT)) {
                const gap = cMin - cMax;
                return { status: 'close', final: null, surplus: null, gap };
            } else {
                const gap = cMin - cMax;
                return { status: 'fail', final: null, surplus: null, gap };
            }
        }

        // Test helper
        function assert(condition, message) {
            if (!condition) {
                throw new Error(message);
            }
        }

        function assertStrictEqual(actual, expected, message) {
            if (actual !== expected) {
                throw new Error(`${message}: expected ${expected}, got ${actual}`);
            }
        }

        // Tests
        const tests = [
            {
                name: 'Success: Overlap (160k max, 140k min)',
                run: () => {
                    const out = computeOutcome(160000, 140000);
                    assertStrictEqual(out.status, 'success', 'Status should be success');
                    assertStrictEqual(out.surplus, 20000, 'Surplus should be 20000');
                    assertStrictEqual(out.final, 150000, 'Final should be 150k');
                    assertStrictEqual(out.gap, null, 'Gap should be null');
                }
            },
            {
                name: 'Success: With rounding (145k max, 135k min)',
                run: () => {
                    const out = computeOutcome(145000, 135000);
                    assertStrictEqual(out.status, 'success', 'Status should be success');
                    assertStrictEqual(out.surplus, 10000, 'Surplus should be 10000');
                    assertStrictEqual(out.final, 140000, 'Final should round to 140k');
                }
            },
            {
                name: 'Close: Exactly 10% (140k max, 154k min)',
                run: () => {
                    const out = computeOutcome(140000, 154000);
                    assertStrictEqual(out.status, 'close', 'Status should be close at exactly 10%');
                    assertStrictEqual(out.gap, 14000, 'Gap should be 14000');
                    assertStrictEqual(out.final, null, 'Final should be null');
                }
            },
            {
                name: 'Close: Within 10% (140k max, 150k min)',
                run: () => {
                    const out = computeOutcome(140000, 150000);
                    assertStrictEqual(out.status, 'close', 'Status should be close');
                    assertStrictEqual(out.gap, 10000, 'Gap should be 10000');
                }
            },
            {
                name: 'Fail: >10% (140k max, 160k min)',
                run: () => {
                    const out = computeOutcome(140000, 160000);
                    assertStrictEqual(out.status, 'fail', 'Status should be fail');
                    assertStrictEqual(out.gap, 20000, 'Gap should be 20000');
                    assertStrictEqual(out.final, null, 'Final should be null');
                }
            },
            {
                name: 'Success: Exact match (150k max, 150k min)',
                run: () => {
                    const out = computeOutcome(150000, 150000);
                    assertStrictEqual(out.status, 'success', 'Exact match should be success');
                    assertStrictEqual(out.surplus, 0, 'Surplus should be 0');
                    assertStrictEqual(out.final, 150000, 'Final should be 150k');
                }
            },
            {
                name: 'Fail: Just above 10% (140k max, 154001 min)',
                run: () => {
                    const out = computeOutcome(140000, 154001);
                    assertStrictEqual(out.status, 'fail', 'Just above 10% should be fail');
                }
            },
            {
                name: 'Success: Rounding edge case (143500 max, 136500 min)',
                run: () => {
                    const out = computeOutcome(143500, 136500);
                    assertStrictEqual(out.status, 'success', 'Status should be success');
                    // Midpoint is 140000, should round to 140000
                    assertStrictEqual(out.final, 140000, 'Should round to 140k');
                }
            }
        ];

        function runTests() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            resultsDiv.innerHTML = '';
            summaryDiv.style.display = 'none';

            let passed = 0;
            let failed = 0;

            tests.forEach((test, index) => {
                const testDiv = document.createElement('div');
                testDiv.className = 'test';
                
                try {
                    test.run();
                    testDiv.classList.add('pass');
                    testDiv.innerHTML = `
                        <div class="test-name">✅ Test ${index + 1}: ${test.name}</div>
                        <div class="result" style="color: #4ade80;">PASSED</div>
                    `;
                    passed++;
                } catch (error) {
                    testDiv.classList.add('fail');
                    testDiv.innerHTML = `
                        <div class="test-name">❌ Test ${index + 1}: ${test.name}</div>
                        <div class="result" style="color: #f87171;">FAILED: ${error.message}</div>
                    `;
                    failed++;
                }
                
                resultsDiv.appendChild(testDiv);
            });

            // Summary
            summaryDiv.style.display = 'block';
            const total = tests.length;
            const color = failed === 0 ? '#4ade80' : '#f87171';
            summaryDiv.innerHTML = `
                <h2 style="color: ${color};">Test Summary</h2>
                <p>Total: ${total} | Passed: ${passed} | Failed: ${failed}</p>
                ${failed === 0 
                    ? '<p style="color: #4ade80; font-weight: bold;">✅ All tests passed!</p>'
                    : '<p style="color: #f87171; font-weight: bold;">❌ Some tests failed</p>'
                }
            `;
        }

        // Auto-run on load
        window.onload = () => runTests();
    </script>
</body>
</html>

